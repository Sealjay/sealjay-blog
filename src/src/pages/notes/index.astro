---
import Layout from "../../layouts/IndexLayout.astro";
import { getCollection } from "astro:content";
import FormattedDate from "../../components/partials/FormattedDate.astro";

const notes = (await getCollection("note")).sort(
  (b, a) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf()
);
const lastNoteDate = notes.length > 0 ? new Date(notes[0].data.pubDateTime) : new Date();

// Group notes by date (YYYY-MM-DD)
const notesByDate = new Map<string, typeof notes>();
for (const note of notes) {
  const dateKey = note.data.pubDateTime.toISOString().slice(0, 10);
  if (!notesByDate.has(dateKey)) {
    notesByDate.set(dateKey, []);
  }
  notesByDate.get(dateKey)!.push(note);
}

// Sort notes within each day oldest-first (earliest at top)
for (const dayNotes of notesByDate.values()) {
  dayNotes.sort((a, b) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf());
}

// Find day summary for each date group (from any note that has one)
function getDaySummary(dayNotes: typeof notes): string | undefined {
  for (const n of dayNotes) {
    if (n.data.daySummary) return n.data.daySummary;
  }
  return undefined;
}
---

<Layout
  title="Notes"
  description="Quick thoughts, links, and things I find interesting."
  pubDateTime={new Date("1 March 2023")}
  updatedDate={lastNoteDate}
>
  <div class="mx-auto max-w-3xl">
    <!-- Page Header -->
    <div class="mb-10 md:mb-16">
      <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 mb-4">
        <span class="text-gradient">Notes</span>
      </h1>
      <p class="text-lg text-zinc-600 dark:text-zinc-400 max-w-2xl">
        Quick thoughts, links, and things I find interesting.
      </p>
    </div>

    <!-- Timeline -->
    <div class="relative">
      <!-- Vertical timeline line -->
      <div class="absolute left-[9px] top-2 bottom-2 w-px bg-zinc-200 dark:bg-zinc-700/60"></div>

      <div class="flex flex-col gap-10">
        {[...notesByDate.entries()].map(([dateKey, dayNotes]) => {
          const dateObj = new Date(dateKey + 'T00:00:00Z');
          const daySummary = getDaySummary(dayNotes);
          return (
            <div>
              {/* Date header */}
              <div class="relative pl-10 mb-4">
                <div class="absolute left-0 top-1 h-[18px] w-[18px] rounded-full border-2 border-white dark:border-zinc-900 bg-accent-500 dark:bg-accent-400" />
                <h2 class="text-sm font-semibold text-zinc-700 dark:text-zinc-300 uppercase tracking-wide">
                  <a href={`/notes/${dateKey}/`} class="hover:text-accent-600 dark:hover:text-accent-400 transition-colors">
                    <FormattedDate date={dateObj} />
                  </a>
                </h2>
                {daySummary && dayNotes.length > 1 && (
                  <p class="mt-1 text-xs text-zinc-500 dark:text-zinc-400 italic">
                    <span class="not-italic font-medium text-zinc-400 dark:text-zinc-500">AI summary</span> â€” {daySummary}
                  </p>
                )}
              </div>

              {/* Notes for this day */}
              <div class="flex flex-col gap-4">
                {dayNotes.map((note) => (
                  <div id={note.slug} class="relative pl-10 scroll-mt-20">
                    {/* Timeline dot */}
                    <div
                      class:list={[
                        'absolute left-0 top-3 h-[10px] w-[10px] ml-[4px] rounded-full',
                        note.data.isHighlight
                          ? 'bg-accent-500 dark:bg-accent-400 shadow-sm shadow-accent-500/30'
                          : 'bg-zinc-300 dark:bg-zinc-600',
                      ]}
                    />

                    <div class="rounded-xl bg-white/90 dark:bg-zinc-800/70 backdrop-blur ring-1 ring-zinc-200/60 dark:ring-zinc-700/40 shadow-sm hover:shadow-md transition-all duration-300 p-5">
                      {/* Top row: time + highlight badge */}
                      <div class="flex items-center gap-2 mb-2">
                        <a
                          href={`/notes/${dateKey}/#${note.slug}`}
                          class="text-xs text-zinc-400 dark:text-zinc-500 hover:text-accent-600 dark:hover:text-accent-400 transition-colors tabular-nums"
                        >
                          {note.data.pubDateTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false })}
                        </a>
                        {note.data.isHighlight && (
                          <span class="inline-flex items-center rounded-full bg-accent-100 dark:bg-accent-900/40 px-2.5 py-0.5 text-xs font-medium text-accent-700 dark:text-accent-300">
                            Highlight
                          </span>
                        )}
                      </div>

                      {/* Title (optional, linked to day page) */}
                      {note.data.title && (
                        <h3 class="text-lg font-bold text-zinc-900 dark:text-zinc-100 mb-1">
                          <a
                            href={`/notes/${dateKey}/#${note.slug}`}
                            class="hover:text-accent-600 dark:hover:text-accent-400 transition-colors"
                          >
                            {note.data.title}
                          </a>
                        </h3>
                      )}

                      {/* Description / body preview */}
                      {note.data.description && (
                        <p class="text-sm text-zinc-600 dark:text-zinc-400 leading-relaxed mb-3">
                          {note.data.description}
                        </p>
                      )}

                      {/* Bottom row: tags + external link */}
                      <div class="flex flex-wrap items-center gap-2">
                        {note.data.tags && note.data.tags.length > 0 && (
                          note.data.tags.map((tag: string) => (
                            <span class="inline-flex items-center rounded-full bg-zinc-100 dark:bg-zinc-700/70 px-2.5 py-0.5 text-xs font-medium text-zinc-700 dark:text-zinc-300">
                              #{tag}
                            </span>
                          ))
                        )}

                        {note.data.externalUrl && (
                          <a
                            href={note.data.externalUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="inline-flex items-center gap-1 rounded-full bg-zinc-100 dark:bg-zinc-700/70 px-2.5 py-0.5 text-xs font-medium text-accent-600 dark:text-accent-400 hover:bg-zinc-200 dark:hover:bg-zinc-600/70 transition-colors"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                            {note.data.externalPlatform || 'Link'}
                          </a>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>

    {notes.length === 0 && (
      <p class="text-center text-zinc-500 dark:text-zinc-400 py-12">
        No notes yet. Check back soon!
      </p>
    )}
  </div>
</Layout>
