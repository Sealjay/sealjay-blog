---
import { getCollection } from 'astro:content'
import IndexLayout from '../../layouts/IndexLayout.astro'
import FormattedDate from '../../components/partials/FormattedDate.astro'
import Giscus from '../../components/embeds/Giscus.astro'
import Webmentions from '../../components/partials/Webmentions.astro'
import Mastodon from '../../components/socialicons/Mastodon.astro'

export async function getStaticPaths() {
  const allNotes = await getCollection('note')

  // Group notes by date (YYYY-MM-DD)
  const notesByDate = new Map<string, typeof allNotes>()
  for (const note of allNotes) {
    const dateKey = note.data.pubDateTime.toISOString().slice(0, 10)
    if (!notesByDate.has(dateKey)) notesByDate.set(dateKey, [])
    notesByDate.get(dateKey)!.push(note)
  }

  return [...notesByDate.entries()].map(([dateKey, notes]) => ({
    params: { slug: dateKey },
    props: {
      dateKey,
      notes: notes.sort((a, b) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf()),
    },
  }))
}

const { dateKey, notes } = Astro.props
const dateObj = new Date(dateKey + 'T00:00:00Z')
const daySummary = notes.find((n: any) => n.data.daySummary)?.data.daySummary

// Build a lookup from mastodonUrl → local note for resolving self-reply threads
const allNotes = await getCollection('note')
const mastodonUrlToNote = new Map<string, { slug: string; dateKey: string; description?: string }>()
for (const n of allNotes) {
  if (n.data.mastodonUrl) {
    const nDateKey = n.data.pubDateTime.toISOString().slice(0, 10)
    mastodonUrlToNote.set(n.data.mastodonUrl, {
      slug: n.slug,
      dateKey: nDateKey,
      description: n.data.description,
    })
  }
}

// Extract a human-readable label from a URL (e.g. @user@instance for Mastodon)
function getReplyLabel(url: string): string {
  try {
    const parsed = new URL(url)
    const pathMatch = parsed.pathname.match(/^\/@([^/]+)/)
    if (pathMatch) {
      return `@${pathMatch[1]}@${parsed.hostname}`
    }
    return parsed.hostname + parsed.pathname
  } catch {
    return url
  }
}

// Resolve an inReplyTo URL: if it points to a local note, return the local path
function resolveReplyLink(url: string): { href: string; isLocal: boolean } {
  const localNote = mastodonUrlToNote.get(url)
  if (localNote) {
    return { href: `/notes/${localNote.dateKey}/#${localNote.slug}`, isLocal: true }
  }
  return { href: url, isLocal: false }
}

// Render all note bodies
const rendered = await Promise.all(notes.map(async (n: any) => {
  const { Content } = await n.render()
  const hasBody = n.body?.trim().length > 0
  return { note: n, Content, hasBody }
}))

const pageTitle = notes.length === 1 && notes[0].data.title
  ? notes[0].data.title
  : `Notes — ${dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}`
const pageDescription = daySummary
  ?? notes.map((n: any) => n.data.description).filter(Boolean).join(' · ')
  ?? 'Notes from Sealjay.'
---

<IndexLayout title={pageTitle} description={pageDescription}>
  <div class="mx-auto max-w-3xl">
    <a
      href="/notes"
      class="mb-6 inline-flex items-center gap-1 text-sm text-zinc-500 transition hover:text-accent-600 dark:text-zinc-400 dark:hover:text-accent-400"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
        <path
          fill-rule="evenodd"
          d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
          clip-rule="evenodd"
        />
      </svg>
      Back to notes
    </a>

    {/* Day header */}
    <header class="mb-10">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100">
        <FormattedDate date={dateObj} />
      </h1>
      {daySummary && notes.length > 1 && (
        <p class="mt-2 text-sm text-zinc-500 dark:text-zinc-400 italic">
          <span class="not-italic font-medium text-zinc-400 dark:text-zinc-500">AI summary</span> — {daySummary}
        </p>
      )}
    </header>

    {/* Notes for this day */}
    <div class="flex flex-col gap-10">
      {rendered.map(({ note, Content, hasBody }: any) => (
        <article id={note.slug} class="h-entry scroll-mt-20">
          <a class="u-url" href={`/notes/${dateKey}/#${note.slug}`} style="display:none">{note.data.title || 'Note'}</a>
          <time class="dt-published" datetime={note.data.pubDateTime.toISOString()} style="display:none">{note.data.pubDateTime.toISOString()}</time>
          <span class="p-author h-card" style="display:none">
            <a class="u-url p-name" href="https://sealjay.com">Chris Lloyd-Jones</a>
          </span>
          {note.data.mastodonUrl && (
            <a class="u-syndication" href={note.data.mastodonUrl} rel="syndication" style="display:none">Mastodon</a>
          )}
          {note.data.inReplyTo && (() => {
            const reply = resolveReplyLink(note.data.inReplyTo)
            const label = getReplyLabel(note.data.inReplyTo)
            const isSelfThread = reply.isLocal
            const localParent = isSelfThread ? mastodonUrlToNote.get(note.data.inReplyTo) : undefined
            const selfThreadLabel = localParent?.description
              ? localParent.description.length > 80 ? localParent.description.slice(0, 80) + '…' : localParent.description
              : label
            return (
              <div class="not-prose mb-4 rounded-lg border border-accent-200 dark:border-accent-800/40 bg-accent-50/50 dark:bg-accent-900/20 px-4 py-3">
                <div class="flex items-center gap-1.5">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-accent-500 dark:text-accent-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
                  </svg>
                  <span class="text-xs font-medium uppercase tracking-wide text-accent-600 dark:text-accent-400">
                    {isSelfThread ? 'Continuing thread' : 'In reply to'}
                  </span>
                </div>
                <a
                  class="u-in-reply-to block mt-1 text-sm text-accent-700 dark:text-accent-300 hover:underline focus:underline focus:outline-none truncate"
                  rel={isSelfThread ? 'in-reply-to' : 'in-reply-to noopener noreferrer'}
                  href={reply.href}
                  title={isSelfThread ? selfThreadLabel : note.data.inReplyTo}
                  {...(!reply.isLocal ? { target: '_blank' } : {})}
                >
                  {isSelfThread ? selfThreadLabel : label}
                  {!reply.isLocal && <span class="sr-only"> (opens in new tab)</span>}
                </a>
              </div>
            )
          })()}
          {/* Note header */}
          <div class="mb-4">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-xs text-zinc-400 dark:text-zinc-500 tabular-nums">
                {note.data.pubDateTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false })}
              </span>
              {note.data.isHighlight && (
                <span class="inline-flex items-center rounded-full bg-accent-100 dark:bg-accent-900/40 px-2.5 py-0.5 text-xs font-medium text-accent-700 dark:text-accent-300">
                  Highlight
                </span>
              )}
            </div>
            {note.data.title && (
              <h2 class="p-name text-xl font-bold text-zinc-900 dark:text-zinc-100 mb-1">{note.data.title}</h2>
            )}

            {note.data.description && !hasBody && (
              <p class="p-summary text-base text-zinc-600 dark:text-zinc-400 leading-relaxed">{note.data.description}</p>
            )}
            {note.data.description && hasBody && (
              <p class="p-summary sr-only">{note.data.description}</p>
            )}
          </div>

          {/* Tags + external link */}
          <div class="flex flex-wrap items-center gap-2 mb-4">
            {note.data.tags && note.data.tags.length > 0 && (
              note.data.tags.map((tag: string) => (
                <span class="inline-flex items-center rounded-full bg-zinc-100 dark:bg-zinc-700/70 px-2.5 py-0.5 text-xs font-medium text-zinc-700 dark:text-zinc-300">
                  #{tag}
                </span>
              ))
            )}

            {note.data.externalUrl && (
              <a
                href={note.data.externalUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-1 rounded-full bg-zinc-100 dark:bg-zinc-700/70 px-2.5 py-0.5 text-xs font-medium text-accent-600 dark:text-accent-400 hover:bg-zinc-200 dark:hover:bg-zinc-600/70 transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                {note.data.externalPlatform || 'Link'}
              </a>
            )}

            {note.data.mastodonUrl && (
              <a
                href={note.data.mastodonUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center rounded-full text-zinc-400 dark:text-zinc-500 hover:text-accent-600 dark:hover:text-accent-400 transition-colors"
                title="View on Mastodon"
              >
                <Mastodon class="h-4 w-4" />
                <span class="sr-only">View on Mastodon</span>
              </a>
            )}
          </div>

          {/* Note body (if any MDX content) */}
          <div class="e-content prose prose-lg dark:prose-invert prose-headings:font-semibold prose-a:text-accent-600 dark:prose-a:text-accent-400">
            <Content />
          </div>

          {/* Divider between notes */}
          {rendered.indexOf(rendered.find((r: any) => r.note === note)!) < rendered.length - 1 && (
            <div class="mt-10 h-px bg-gradient-to-r from-transparent via-zinc-200 dark:via-zinc-700/60 to-transparent"></div>
          )}
        </article>
      ))}
    </div>

    {/* Discussion — one thread per day */}
    <div class="mt-16 mb-8">
      <Webmentions />
      <div class="h-px bg-gradient-to-r from-transparent via-zinc-300 dark:via-zinc-700 to-transparent mb-8 mt-12"></div>
      <Giscus />
    </div>
  </div>
</IndexLayout>
