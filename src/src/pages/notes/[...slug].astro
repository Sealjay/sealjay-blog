---
import { getCollection } from 'astro:content'
import IndexLayout from '../../layouts/IndexLayout.astro'
import FormattedDate from '../../components/partials/FormattedDate.astro'
import Giscus from '../../components/embeds/Giscus.astro'
import Webmentions from '../../components/partials/Webmentions.astro'

export async function getStaticPaths() {
  const allNotes = await getCollection('note')

  // Group notes by date (YYYY-MM-DD)
  const notesByDate = new Map<string, typeof allNotes>()
  for (const note of allNotes) {
    const dateKey = note.data.pubDateTime.toISOString().slice(0, 10)
    if (!notesByDate.has(dateKey)) notesByDate.set(dateKey, [])
    notesByDate.get(dateKey)!.push(note)
  }

  return [...notesByDate.entries()].map(([dateKey, notes]) => ({
    params: { slug: dateKey },
    props: {
      dateKey,
      notes: notes.sort((a, b) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf()),
    },
  }))
}

const { dateKey, notes } = Astro.props
const dateObj = new Date(dateKey + 'T00:00:00Z')
const daySummary = notes.find((n: any) => n.data.daySummary)?.data.daySummary

// Render all note bodies
const rendered = await Promise.all(notes.map(async (n: any) => {
  const { Content } = await n.render()
  const hasBody = n.body?.trim().length > 0
  return { note: n, Content, hasBody }
}))

const pageTitle = notes.length === 1 && notes[0].data.title
  ? notes[0].data.title
  : `Notes — ${dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}`
const pageDescription = daySummary
  ?? notes.map((n: any) => n.data.description).filter(Boolean).join(' · ')
  ?? 'Notes from Sealjay.'
---

<IndexLayout title={pageTitle} description={pageDescription}>
  <div class="mx-auto max-w-3xl">
    <a
      href="/notes"
      class="mb-6 inline-flex items-center gap-1 text-sm text-zinc-500 transition hover:text-accent-600 dark:text-zinc-400 dark:hover:text-accent-400"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
        <path
          fill-rule="evenodd"
          d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
          clip-rule="evenodd"
        />
      </svg>
      Back to notes
    </a>

    {/* Day header */}
    <header class="mb-10">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100">
        <FormattedDate date={dateObj} />
      </h1>
      {daySummary && notes.length > 1 && (
        <p class="mt-2 text-sm text-zinc-500 dark:text-zinc-400 italic">{daySummary}</p>
      )}
    </header>

    {/* Notes for this day */}
    <div class="flex flex-col gap-10">
      {rendered.map(({ note, Content, hasBody }: any) => (
        <article id={note.slug} class="h-entry scroll-mt-20">
          <a class="u-url" href={`/notes/${dateKey}/#${note.slug}`} style="display:none">{note.data.title || 'Note'}</a>
          <time class="dt-published" datetime={note.data.pubDateTime.toISOString()} style="display:none">{note.data.pubDateTime.toISOString()}</time>
          <span class="p-author h-card" style="display:none">
            <a class="u-url p-name" href="https://sealjay.com">Chris Lloyd-Jones</a>
          </span>
          {note.data.mastodonUrl && (
            <a class="u-syndication" href={note.data.mastodonUrl} rel="syndication" style="display:none">Mastodon</a>
          )}
          {note.data.inReplyTo && (
            <div class="not-prose mb-4 rounded-lg border border-accent-200 dark:border-accent-800/40 bg-accent-50/50 dark:bg-accent-900/20 px-4 py-3">
              <span class="text-xs font-medium uppercase tracking-wide text-accent-600 dark:text-accent-400">In reply to</span>
              <a class="u-in-reply-to block mt-1 text-sm text-accent-700 dark:text-accent-300 hover:underline break-all" rel="in-reply-to" href={note.data.inReplyTo}>{note.data.inReplyTo}</a>
            </div>
          )}
          {/* Note header */}
          <div class="mb-4">
            {note.data.title && (
              <h2 class="p-name text-xl font-bold text-zinc-900 dark:text-zinc-100 mb-1">{note.data.title}</h2>
            )}

            {note.data.description && !hasBody && (
              <p class="p-summary text-base text-zinc-600 dark:text-zinc-400 leading-relaxed">{note.data.description}</p>
            )}
            {note.data.description && hasBody && (
              <p class="p-summary sr-only">{note.data.description}</p>
            )}
          </div>

          {/* Tags + external link */}
          <div class="flex flex-wrap items-center gap-2 mb-4">
            {note.data.tags && note.data.tags.length > 0 && (
              note.data.tags.map((tag: string) => (
                <span class="inline-block rounded-full bg-accent-100 px-3 py-0.5 text-sm font-medium text-accent-700 dark:bg-accent-900/30 dark:text-accent-300">
                  #{tag}
                </span>
              ))
            )}

            {note.data.externalUrl && (
              <a
                href={note.data.externalUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-1 rounded-full bg-zinc-100 dark:bg-zinc-700/70 px-3 py-0.5 text-sm font-medium text-accent-600 dark:text-accent-400 hover:bg-zinc-200 dark:hover:bg-zinc-600/70 transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                {note.data.externalPlatform || 'Link'}
              </a>
            )}

            {note.data.mastodonUrl && (
              <a
                href={note.data.mastodonUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center rounded-full text-zinc-400 dark:text-zinc-500 hover:text-accent-600 dark:hover:text-accent-400 transition-colors"
                title="View on Mastodon"
              >
                <svg viewBox="0 0 24 24" aria-hidden="true" class="h-4 w-4" fill="currentColor">
                  <path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054 19.648 19.648 0 0 0 4.636.536c.392 0 .785 0 1.18-.012 2.688-.076 5.533-.399 5.81-3.113.012-.107.018-1.327.018-1.433 0-1.38.494-3.818-.072-5.487z" />
                  <path d="M19.903 7.536v5.3c0 .97-.233 1.752-.698 2.272-.47.525-1.089.79-1.856.79-.86 0-1.527-.33-1.975-.992-.447-.66-.672-1.573-.672-2.738V7.536h-2.19v4.632c0 1.164-.224 2.077-.672 2.738-.448.661-1.114.992-1.975.992-.767 0-1.387-.265-1.856-.79-.465-.52-.698-1.302-.698-2.272v-5.3H5.121v5.454c0 .97.243 1.873.728 2.556.49.688 1.14 1.167 1.943 1.46.508.185 1.067.277 1.676.277 1.267 0 2.26-.466 2.96-1.395.7.93 1.693 1.395 2.96 1.395.609 0 1.168-.092 1.676-.277.803-.293 1.454-.772 1.943-1.46.485-.683.728-1.586.728-2.556V7.536h-2.19z" />
                </svg>
                <span class="sr-only">View on Mastodon</span>
              </a>
            )}
          </div>

          {/* Note body (if any MDX content) */}
          <div class="e-content prose prose-lg dark:prose-invert prose-headings:font-semibold prose-a:text-accent-600 dark:prose-a:text-accent-400">
            <Content />
          </div>

          {/* Divider between notes */}
          {rendered.indexOf(rendered.find((r: any) => r.note === note)!) < rendered.length - 1 && (
            <div class="mt-10 h-px bg-gradient-to-r from-transparent via-zinc-200 dark:via-zinc-700/60 to-transparent"></div>
          )}
        </article>
      ))}
    </div>

    {/* Discussion — one thread per day */}
    <div class="mt-16 mb-8">
      <Webmentions />
      <div class="h-px bg-gradient-to-r from-transparent via-zinc-300 dark:via-zinc-700 to-transparent mb-8 mt-12"></div>
      <Giscus />
    </div>
  </div>
</IndexLayout>
