---
import { getCollection } from 'astro:content'
import BaseLayout from '../../layouts/BaseLayout.astro'
import Container from '../../components/containers/Container.astro'
import FormattedDate from '../../components/partials/FormattedDate.astro'
import Giscus from '../../components/embeds/Giscus.astro'
import Webmentions from '../../components/partials/Webmentions.astro'
import Mastodon from '../../components/socialicons/Mastodon.astro'

export async function getStaticPaths() {
  const allNotes = await getCollection('note')

  // Group notes by date (YYYY-MM-DD)
  const notesByDate = new Map<string, typeof allNotes>()
  for (const note of allNotes) {
    const dateKey = note.data.pubDateTime.toISOString().slice(0, 10)
    if (!notesByDate.has(dateKey)) notesByDate.set(dateKey, [])
    notesByDate.get(dateKey)!.push(note)
  }

  return [...notesByDate.entries()].map(([dateKey, notes]) => ({
    params: { slug: dateKey },
    props: {
      dateKey,
      notes: notes.sort((a, b) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf()),
    },
  }))
}

const { dateKey, notes } = Astro.props
const dateObj = new Date(dateKey + 'T00:00:00Z')
const daySummary = notes.find((n: any) => n.data.daySummary)?.data.daySummary

// Build a lookup from mastodonUrl -> local note for resolving self-reply threads
const allNotes = await getCollection('note')
const mastodonUrlToNote = new Map<string, { slug: string; dateKey: string; description?: string }>()
for (const n of allNotes) {
  if (n.data.mastodonUrl) {
    const nDateKey = n.data.pubDateTime.toISOString().slice(0, 10)
    mastodonUrlToNote.set(n.data.mastodonUrl, {
      slug: n.slug,
      dateKey: nDateKey,
      description: n.data.description,
    })
  }
}

// Extract a human-readable label from a URL (e.g. @user@instance for Mastodon)
function getReplyLabel(url: string): string {
  try {
    const parsed = new URL(url)
    const pathMatch = parsed.pathname.match(/^\/@([^/]+)/)
    if (pathMatch) {
      return `@${pathMatch[1]}@${parsed.hostname}`
    }
    return parsed.hostname + parsed.pathname
  } catch {
    return url
  }
}

// Resolve an inReplyTo URL: if it points to a local note, return the local path
function resolveReplyLink(url: string): { href: string; isLocal: boolean } {
  const localNote = mastodonUrlToNote.get(url)
  if (localNote) {
    return { href: `/notes/${localNote.dateKey}/#${localNote.slug}`, isLocal: true }
  }
  return { href: url, isLocal: false }
}

// Render all note bodies
const rendered = await Promise.all(notes.map(async (n: any) => {
  const { Content } = await n.render()
  const hasBody = n.body?.trim().length > 0
  return { note: n, Content, hasBody }
}))

const pageTitle = notes.length === 1 && notes[0].data.title
  ? notes[0].data.title
  : `Notes — ${dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}`
const pageDescription = daySummary
  ?? notes.map((n: any) => n.data.description).filter(Boolean).join(' · ')
  ?? 'Notes from Sealjay.'
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <Container>
    <div class="note-detail">
      <a href="/notes" class="note-detail__back">
        <svg xmlns="http://www.w3.org/2000/svg" class="note-detail__back-icon" viewBox="0 0 20 20" fill="currentColor">
          <path
            fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
            clip-rule="evenodd"
          />
        </svg>
        Back to notes
      </a>

      {/* Day header */}
      <header class="note-detail__header">
        <h1 class="note-detail__title font-heading">
          <FormattedDate date={dateObj} />
        </h1>
        {daySummary && notes.length > 1 && (
          <p class="note-detail__summary">
            <span class="note-detail__summary-label">AI summary</span> — {daySummary}
          </p>
        )}
      </header>

      {/* Notes for this day */}
      <div class="note-detail__notes">
        {rendered.map(({ note, Content, hasBody }: any) => (
          <article id={note.slug} class="h-entry note-article scroll-mt-20">
            <a class="u-url" href={`/notes/${dateKey}/#${note.slug}`} style="display:none">{note.data.title || 'Note'}</a>
            <time class="dt-published" datetime={note.data.pubDateTime.toISOString()} style="display:none">{note.data.pubDateTime.toISOString()}</time>
            <span class="p-author h-card" style="display:none">
              <a class="u-url p-name" href="https://sealjay.com">Chris Lloyd-Jones</a>
            </span>
            {note.data.mastodonUrl && (
              <a class="u-syndication" href={note.data.mastodonUrl} rel="syndication" style="display:none">Mastodon</a>
            )}
            {note.data.inReplyTo && (() => {
              const reply = resolveReplyLink(note.data.inReplyTo)
              const label = getReplyLabel(note.data.inReplyTo)
              const isSelfThread = reply.isLocal
              const localParent = isSelfThread ? mastodonUrlToNote.get(note.data.inReplyTo) : undefined
              const selfThreadLabel = localParent?.description
                ? localParent.description.length > 80 ? localParent.description.slice(0, 80) + '\u2026' : localParent.description
                : label
              return (
                <div class="note-article__reply-box">
                  <div class="note-article__reply-header">
                    <svg xmlns="http://www.w3.org/2000/svg" class="note-article__reply-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
                    </svg>
                    <span class="note-article__reply-label">
                      {isSelfThread ? 'Continuing thread' : 'In reply to'}
                    </span>
                  </div>
                  <a
                    class="u-in-reply-to note-article__reply-link"
                    rel={isSelfThread ? 'in-reply-to' : 'in-reply-to noopener noreferrer'}
                    href={reply.href}
                    title={isSelfThread ? selfThreadLabel : note.data.inReplyTo}
                    {...(!reply.isLocal ? { target: '_blank' } : {})}
                  >
                    {isSelfThread ? selfThreadLabel : label}
                    {!reply.isLocal && <span class="sr-only"> (opens in new tab)</span>}
                  </a>
                </div>
              )
            })()}

            {/* Note header */}
            <div class="note-article__header">
              <div class="note-article__meta">
                <span class="note-article__time">
                  {note.data.pubDateTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false })}
                </span>
                {note.data.isHighlight && (
                  <span class="note-article__highlight">Highlight</span>
                )}
              </div>
              {note.data.title && (
                <h2 class="p-name note-article__title font-heading">{note.data.title}</h2>
              )}

              {note.data.description && !hasBody && (
                <p class="p-summary note-article__desc">{note.data.description}</p>
              )}
              {note.data.description && hasBody && (
                <p class="p-summary sr-only">{note.data.description}</p>
              )}
            </div>

            {/* Tags + external link */}
            <div class="note-article__tags">
              {note.data.tags && note.data.tags.length > 0 && (
                note.data.tags.map((tag: string) => (
                  <span class="p-category note-article__tag">#{tag}</span>
                ))
              )}

              {note.data.externalUrl && (
                <a
                  href={note.data.externalUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="note-article__external-link"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="note-article__external-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                  {note.data.externalPlatform || 'Link'}
                </a>
              )}

              {note.data.mastodonUrl && (
                <a
                  href={note.data.mastodonUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="note-article__mastodon"
                  title="View on Mastodon"
                >
                  <Mastodon class="h-4 w-4" />
                  <span class="sr-only">View on Mastodon</span>
                </a>
              )}
            </div>

            {/* Note body (if any MDX content) */}
            <div class="e-content note-article__content prose prose-lg">
              <Content />
            </div>

            {/* Divider between notes */}
            {rendered.indexOf(rendered.find((r: any) => r.note === note)!) < rendered.length - 1 && (
              <div class="note-article__divider" />
            )}
          </article>
        ))}
      </div>

      {/* Discussion - one thread per day */}
      <div class="note-detail__discussion">
        <Webmentions />
        <div class="note-detail__divider" />
        <Giscus />
      </div>
    </div>
  </Container>
</BaseLayout>

<style>
  .note-detail {
    max-width: 560px;
    margin: 0 auto;
  }

  .note-detail__back {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--duration-fast) var(--ease-out);
  }

  .note-detail__back:hover {
    color: var(--color-primary);
  }

  .note-detail__back-icon {
    width: 1rem;
    height: 1rem;
  }

  .note-detail__header {
    margin-bottom: 2.5rem;
  }

  .note-detail__title {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.025em;
    color: var(--color-text);
    margin: 0;
  }

  @media (min-width: 640px) {
    .note-detail__title {
      font-size: 1.875rem;
    }
  }

  .note-detail__summary {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-subtle);
    font-style: italic;
  }

  .note-detail__summary-label {
    font-style: normal;
    font-weight: 500;
    color: var(--color-text-subtle);
  }

  .note-detail__notes {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  /* Note article */
  .note-article__reply-box {
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    background: var(--color-primary-muted);
    border: 1px solid var(--color-border);
  }

  .note-article__reply-header {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .note-article__reply-icon {
    width: 0.875rem;
    height: 0.875rem;
    color: var(--color-primary);
    flex-shrink: 0;
  }

  .note-article__reply-label {
    font-family: var(--font-heading);
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-primary);
  }

  .note-article__reply-link {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color var(--duration-fast) var(--ease-out);
  }

  .note-article__reply-link:hover {
    color: var(--color-primary);
    text-decoration: underline;
  }

  .note-article__header {
    margin-bottom: 1rem;
  }

  .note-article__meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .note-article__time {
    font-family: var(--font-code);
    font-size: 0.75rem;
    color: var(--color-text-subtle);
  }

  .note-article__highlight {
    display: inline-flex;
    align-items: center;
    border-radius: var(--radius-full);
    padding: 2px 8px;
    font-family: var(--font-heading);
    font-size: 0.6875rem;
    font-weight: 500;
    background: var(--color-warm-muted);
    color: var(--color-warm);
    border: 1px solid color-mix(in srgb, var(--color-warm) 30%, transparent);
  }

  .note-article__title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 0.25rem;
  }

  .note-article__desc {
    font-size: 1rem;
    line-height: 1.75;
    color: var(--color-text-muted);
    margin: 0;
  }

  .note-article__tags {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .note-article__tag {
    display: inline-flex;
    align-items: center;
    border-radius: var(--radius-full);
    padding: 2px 8px;
    font-family: var(--font-heading);
    font-size: 0.6875rem;
    font-weight: 500;
    background: var(--color-bg-alt);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
  }

  .note-article__external-link {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    border-radius: var(--radius-full);
    padding: 2px 8px;
    font-family: var(--font-heading);
    font-size: 0.6875rem;
    font-weight: 500;
    background: var(--color-bg-alt);
    color: var(--color-primary);
    border: 1px solid var(--color-border);
    text-decoration: none;
    transition: background var(--duration-fast) var(--ease-out),
                border-color var(--duration-fast) var(--ease-out);
  }

  .note-article__external-link:hover {
    background: var(--color-primary-muted);
    border-color: var(--color-border-strong);
  }

  .note-article__external-icon {
    width: 0.875rem;
    height: 0.875rem;
  }

  .note-article__mastodon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-subtle);
    text-decoration: none;
    transition: color var(--duration-fast) var(--ease-out);
  }

  .note-article__mastodon:hover {
    color: var(--color-primary);
  }

  .note-article__content {
    color: var(--color-text);
  }

  .note-article__content :global(a) {
    color: var(--color-primary);
  }

  .note-article__content :global(a:hover) {
    color: var(--color-accent);
  }

  .note-article__divider {
    margin-top: 2.5rem;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--color-border-strong), transparent);
  }

  .note-detail__discussion {
    margin-top: 4rem;
    margin-bottom: 2rem;
  }

  .note-detail__divider {
    height: 1px;
    background: linear-gradient(to right, transparent, var(--color-border-strong), transparent);
    margin: 3rem 0 2rem;
  }
</style>
