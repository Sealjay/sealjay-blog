---
import { Picture } from 'astro:assets'
import BaseLayout from '../../layouts/BaseLayout.astro'
import Container from '../../components/containers/Container.astro'
import PageHeader from '../../components/partials/PageHeader.astro'
import FormattedDate from '../../components/partials/FormattedDate.astro'
import Badge from '../../components/partials/Badge.astro'
import { getCollection } from 'astro:content'
import { getOGImagePath } from '../../lib/og-image'
import { getTagStyle } from '../../lib/tag-categories'

const posts = (await getCollection('blog')).sort(
  (b, a) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf(),
)

// Collect all unique tags for the filter bar, sorted by popularity
const tagCounts = new Map<string, number>()
for (const post of posts) {
  if (post.data.tags) {
    for (const tag of post.data.tags) {
      tagCounts.set(tag, (tagCounts.get(tag) ?? 0) + 1)
    }
  }
}
const allTags = [...tagCounts.keys()].sort((a, b) => {
  const countDiff = (tagCounts.get(b) ?? 0) - (tagCounts.get(a) ?? 0)
  return countDiff !== 0 ? countDiff : a.localeCompare(b)
})

const lastPostDate = new Date(posts[0].data.pubDateTime)
---

<BaseLayout
  title="Writing"
  description="Writing on AI, open source, sustainability, and more"
  pubDateTime={new Date('1 March 2023')}
  updatedDate={lastPostDate}
>
  <Container>
    <PageHeader
      title="Writing"
      subtitle="on AI, open source, sustainability, and more"
      center={false}
      breadcrumbs={[
        { label: 'Home', href: '/' },
        { label: 'Writing' },
      ]}
    />

    {/* Tag filter bar */}
    <nav class="tag-filter-bar" aria-label="Filter by tag">
      <a href="/blog" class="tag-pill tag-pill--active" aria-current="page">All</a>
      {allTags.map((tag) => {
        const tagSlug = tag.toLowerCase().replace(/\s+/g, '-')
        return (
          <a href={`/blog/tag/${tagSlug}/`} class="tag-pill">{tag}</a>
        )
      })}
    </nav>

    {/* Article list */}
    <div class="h-feed blog-list" data-page-size="12">
      {posts.map((post, index) => {
        const wordCount = post.body ? post.body.split(/\s+/).length : 0
        const readingTime = wordCount > 0 ? Math.max(1, Math.ceil(wordCount / 200)) : undefined
        const excerpt = post.data.description
          ? post.data.description.length > 120
            ? `${post.data.description.slice(0, 120)}...`
            : post.data.description
          : undefined

        return (
          <a
            href={`/blog/${post.slug}/`}
            class="h-entry u-url blog-card group"
            data-post-index={index}
            style={index >= 12 ? 'display:none' : undefined}
          >
            {post.data.heroImage ? (
              <div class="blog-card__image">
                <Picture
                  src={post.data.heroImage}
                  formats={['avif', 'webp']}
                  alt=""
                  width={800}
                  height={450}
                  layout="constrained"
                  loading="lazy"
                  class="blog-card__img"
                />
              </div>
            ) : (
              <div class="blog-card__image">
                <img
                  src={getOGImagePath(post.slug)}
                  alt=""
                  width="1200"
                  height="630"
                  loading="lazy"
                  decoding="async"
                  class="blog-card__img"
                />
              </div>
            )}
            <div class="blog-card__body">
              {post.data.tags && post.data.tags.length > 0 && (
                <div class="blog-card__tags">
                  {post.data.tags.slice(0, 3).map((tag) => (
                    <span class="blog-card__tag p-category" style={getTagStyle(tag)}>{tag}</span>
                  ))}
                </div>
              )}
              <h2 class="blog-card__title p-name font-heading">{post.data.title}</h2>
              <div class="blog-card__meta">
                <FormattedDate date={post.data.pubDateTime} class="dt-published" />
                {readingTime && (
                  <>
                    <span aria-hidden="true">&middot;</span>
                    <span>{readingTime} min read</span>
                  </>
                )}
              </div>
              {excerpt && (
                <p class="blog-card__excerpt">{excerpt}</p>
              )}
            </div>
          </a>
        )
      })}
    </div>

    {/* Pagination controls */}
    <div class="blog-pagination" data-total={posts.length}>
      <p class="blog-pagination__count">
        Showing <span data-showing>{Math.min(12, posts.length)}</span> of <span data-total-count>{posts.length}</span> posts
      </p>
      {posts.length > 12 && (
        <button class="blog-pagination__btn" type="button" data-load-more>
          Show more
        </button>
      )}
    </div>
  </Container>
</BaseLayout>

<style>
  /* Tag filter bar */
  .tag-filter-bar {
    display: flex;
    flex-wrap: nowrap;
    gap: 0.5rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
    margin-bottom: 2rem;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
  }

  .tag-filter-bar::-webkit-scrollbar {
    height: 4px;
  }

  .tag-filter-bar::-webkit-scrollbar-track {
    background: transparent;
  }

  .tag-filter-bar::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: var(--radius-full);
  }

  .tag-filter-bar::after {
    content: '';
    flex-shrink: 0;
    width: 1rem;
  }

  .tag-pill {
    display: inline-flex;
    align-items: center;
    flex-shrink: 0;
    border-radius: var(--radius-full);
    padding: 0.5rem 0.875rem;
    font-family: var(--font-heading);
    font-size: 0.8125rem;
    font-weight: 500;
    text-decoration: none;
    white-space: nowrap;
    border: 1px solid var(--color-border);
    background: transparent;
    color: var(--color-text-muted);
    transition: background var(--duration-fast) var(--ease-out),
                border-color var(--duration-fast) var(--ease-out),
                color var(--duration-fast) var(--ease-out);
  }

  .tag-pill:hover {
    border-color: var(--color-border-strong);
    color: var(--color-text);
  }

  .tag-pill--active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: #fff;
  }

  .tag-pill--active:hover {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: #fff;
  }

  /* Blog list */
  .blog-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Blog card */
  .blog-card {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
    border-radius: var(--radius-lg);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    box-shadow: var(--color-card-glow);
    overflow: hidden;
    text-decoration: none;
    transition: transform var(--duration-normal) var(--ease-out),
                border-color var(--duration-normal) var(--ease-out),
                box-shadow var(--duration-normal) var(--ease-out);
  }

  @media (min-width: 640px) {
    .blog-card {
      grid-template-columns: 14rem 1fr;
    }
  }

  @media (min-width: 768px) {
    .blog-card {
      grid-template-columns: 16rem 1fr;
    }
  }

  .blog-card:hover {
    transform: translateY(-2px);
    border-color: var(--color-border-strong);
    box-shadow: var(--color-card-glow), var(--color-card-glow-hover);
  }

  .blog-card__image {
    aspect-ratio: 16 / 9;
    overflow: hidden;
  }

  @media (min-width: 640px) {
    .blog-card__image {
      aspect-ratio: auto;
      height: 100%;
    }
  }

  .blog-card__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-slow) var(--ease-out);
  }

  .blog-card:hover .blog-card__img {
    transform: scale(1.05);
  }

  .blog-card__placeholder {
    width: 100%;
    height: 100%;
    min-height: 8rem;
    background: var(--gradient-hero);
  }

  .blog-card__body {
    padding: 1rem 1.5rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .blog-card__tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-bottom: 0.5rem;
  }

  .blog-card__tag {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--tag-bg, var(--color-primary-muted));
    color: var(--tag-color, var(--color-primary));
    border: 1px solid color-mix(in srgb, var(--tag-color, var(--color-primary)) 25%, transparent);
    border-radius: var(--radius-full);
    font-family: var(--font-heading);
    font-size: 0.6875rem;
    font-weight: 500;
    line-height: 1;
    letter-spacing: 0.01em;
  }

  .blog-card__title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    line-height: 1.4;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    transition: color var(--duration-fast) var(--ease-out);
  }

  .blog-card:hover .blog-card__title {
    color: var(--color-primary);
  }

  .blog-card__meta {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: var(--color-text-subtle);
    margin-top: 0.5rem;
  }

  .blog-card__excerpt {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-top: 0.5rem;
    margin-bottom: 0;
  }

  /* Pagination */
  .blog-pagination {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    padding-bottom: 3rem;
    border-top: 1px solid var(--color-border);
  }

  .blog-pagination__count {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  .blog-pagination__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 1.5rem;
    border-radius: var(--radius-full);
    border: 1px solid var(--color-border);
    background: var(--color-surface);
    color: var(--color-text);
    font-family: var(--font-heading);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background var(--duration-fast) var(--ease-out),
                border-color var(--duration-fast) var(--ease-out),
                color var(--duration-fast) var(--ease-out);
  }

  .blog-pagination__btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .blog-pagination__btn[hidden] {
    display: none;
  }
</style>

<script>
  function initBlogPagination() {
    const PAGE_SIZE = 12
    const list = document.querySelector<HTMLElement>('.blog-list')
    const btn = document.querySelector<HTMLButtonElement>('[data-load-more]')
    const showingEl = document.querySelector<HTMLElement>('[data-showing]')
    const totalCountEl = document.querySelector<HTMLElement>('[data-total-count]')

    if (!list) return

    const allCards = Array.from(list.querySelectorAll<HTMLElement>('.blog-card'))
    const total = allCards.length
    let visible = Math.min(PAGE_SIZE, total)

    function updateDisplay() {
      for (let i = 0; i < allCards.length; i++) {
        allCards[i].style.display = i < visible ? '' : 'none'
      }

      if (showingEl) showingEl.textContent = String(visible)
      if (totalCountEl) totalCountEl.textContent = String(total)
      if (btn) {
        btn.hidden = visible >= total
      }
    }

    if (btn) {
      btn.addEventListener('click', () => {
        visible = Math.min(visible + PAGE_SIZE, total)
        updateDisplay()
      })
    }

    // Initial state is already set server-side, but re-sync on Astro page transitions
    updateDisplay()
  }

  document.addEventListener('astro:page-load', initBlogPagination)
  initBlogPagination()
</script>
