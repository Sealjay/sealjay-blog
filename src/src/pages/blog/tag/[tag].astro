---
import BaseLayout from '../../../layouts/BaseLayout.astro'
import Container from '../../../components/containers/Container.astro'
import PageHeader from '../../../components/partials/PageHeader.astro'
import FormattedDate from '../../../components/partials/FormattedDate.astro'
import Badge from '../../../components/partials/Badge.astro'
import { getCollection } from 'astro:content'
import { getOGImagePath } from '../../../lib/og-image'
import { getTagStyle } from '../../../lib/tag-categories'

export async function getStaticPaths() {
  const allPosts = await getCollection('blog')
  const tagSet = new Set<string>()

  for (const post of allPosts) {
    if (post.data.tags) {
      for (const tag of post.data.tags) {
        tagSet.add(tag)
      }
    }
  }

  return [...tagSet].map((tag) => {
    const slug = tag.toLowerCase().replace(/\s+/g, '-')
    const filteredPosts = allPosts
      .filter((post) => post.data.tags?.includes(tag))
      .sort((b, a) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf())

    return {
      params: { tag: slug },
      props: { tag, posts: filteredPosts, allTags: [...tagSet].sort((a, b) => a.localeCompare(b)) },
    }
  })
}

const { tag, posts, allTags } = Astro.props
const isThinTag = posts.length < 2
const lastPostDate = new Date(posts[0].data.pubDateTime)
---

<BaseLayout
  title={`Tagged: ${tag}`}
  description={`Blog posts tagged with "${tag}"`}
  pubDateTime={new Date('1 March 2023')}
  updatedDate={lastPostDate}
  noindex={isThinTag}
>
  <Container>
    <PageHeader
      title={`Tagged: ${tag}`}
      subtitle={`${posts.length} ${posts.length === 1 ? 'post' : 'posts'}`}
      center={false}
      breadcrumbs={[
        { label: 'Home', href: '/' },
        { label: 'Blog', href: '/blog' },
        { label: 'Tag' },
        { label: tag },
      ]}
    />

    {/* Tag filter bar */}
    <nav class="tag-filter-bar" aria-label="Filter by tag">
      <a href="/blog" class="tag-pill">All</a>
      {allTags.map((t: string) => {
        const tagSlug = t.toLowerCase().replace(/\s+/g, '-')
        const isActive = t === tag
        return (
          <a
            href={`/blog/tag/${tagSlug}/`}
            class:list={['tag-pill', isActive && 'tag-pill--active']}
            style={isActive ? getTagStyle(t) : undefined}
            aria-current={isActive ? 'page' : undefined}
          >
            {t}
          </a>
        )
      })}
    </nav>

    {/* Article list */}
    <div class="blog-list" data-page-size="12">
      {posts.map((post, index) => {
        const hasHeroImage = !!post.data.heroImage
        const heroSrc = hasHeroImage ? post.data.heroImage : getOGImagePath(post.slug)
        const firstTag = post.data.tags?.[0]
        const wordCount = post.body ? post.body.split(/\s+/).length : 0
        const readingTime = wordCount > 0 ? Math.max(1, Math.ceil(wordCount / 200)) : undefined
        const excerpt = post.data.description
          ? post.data.description.length > 120
            ? `${post.data.description.slice(0, 120)}...`
            : post.data.description
          : undefined

        return (
          <a
            href={`/blog/${post.slug}/`}
            class="blog-card group"
            data-post-index={index}
            style={index >= 12 ? 'display:none' : undefined}
          >
            <div class="blog-card__image">
              <img
                src={heroSrc}
                alt=""
                width="1200"
                height="630"
                loading="lazy"
                decoding="async"
                class="blog-card__img"
              />
            </div>
            <div class="blog-card__body">
              {firstTag && (
                <span class="blog-card__tag" style={getTagStyle(firstTag)}>{firstTag}</span>
              )}
              <h2 class="blog-card__title font-heading">{post.data.title}</h2>
              <div class="blog-card__meta">
                <FormattedDate date={post.data.pubDateTime} />
                {readingTime && (
                  <>
                    <span aria-hidden="true">&middot;</span>
                    <span>{readingTime} min read</span>
                  </>
                )}
              </div>
              {excerpt && (
                <p class="blog-card__excerpt">{excerpt}</p>
              )}
            </div>
          </a>
        )
      })}
    </div>

    {/* Pagination controls */}
    <div class="blog-pagination" data-total={posts.length}>
      <p class="blog-pagination__count">
        Showing <span data-showing>{Math.min(12, posts.length)}</span> of <span data-total-count>{posts.length}</span> posts
      </p>
      {posts.length > 12 && (
        <button class="blog-pagination__btn" type="button" data-load-more>
          Show more
        </button>
      )}
    </div>
  </Container>
</BaseLayout>

<style>
  /* Tag filter bar */
  .tag-filter-bar {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
    margin-bottom: 2rem;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
  }

  .tag-filter-bar::-webkit-scrollbar {
    height: 4px;
  }

  .tag-filter-bar::-webkit-scrollbar-track {
    background: transparent;
  }

  .tag-filter-bar::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: var(--radius-full);
  }

  .tag-pill {
    display: inline-flex;
    align-items: center;
    flex-shrink: 0;
    border-radius: var(--radius-full);
    padding: 0.375rem 0.875rem;
    font-family: var(--font-heading);
    font-size: 0.8125rem;
    font-weight: 500;
    text-decoration: none;
    white-space: nowrap;
    border: 1px solid var(--color-border);
    background: transparent;
    color: var(--color-text-muted);
    transition: background var(--duration-fast) var(--ease-out),
                border-color var(--duration-fast) var(--ease-out),
                color var(--duration-fast) var(--ease-out);
  }

  .tag-pill:hover {
    border-color: var(--color-border-strong);
    color: var(--color-text);
  }

  .tag-pill--active {
    background: var(--tag-color, var(--color-primary));
    border-color: var(--tag-color, var(--color-primary));
    color: #fff;
  }

  .tag-pill--active:hover {
    background: var(--tag-color, var(--color-primary));
    border-color: var(--tag-color, var(--color-primary));
    color: #fff;
  }

  /* Blog list */
  .blog-list {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  /* Blog card */
  .blog-card {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
    border-radius: var(--radius-lg);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    box-shadow: var(--color-card-glow);
    overflow: hidden;
    text-decoration: none;
    transition: transform var(--duration-normal) var(--ease-out),
                border-color var(--duration-normal) var(--ease-out),
                box-shadow var(--duration-normal) var(--ease-out);
  }

  @media (min-width: 640px) {
    .blog-card {
      grid-template-columns: 14rem 1fr;
    }
  }

  @media (min-width: 768px) {
    .blog-card {
      grid-template-columns: 16rem 1fr;
    }
  }

  .blog-card:hover {
    transform: translateY(-2px);
    border-color: var(--color-border-strong);
    box-shadow: var(--color-card-glow), 0 4px 20px rgba(79, 70, 229, 0.1);
  }

  .blog-card__image {
    aspect-ratio: 16 / 9;
    overflow: hidden;
  }

  @media (min-width: 640px) {
    .blog-card__image {
      aspect-ratio: auto;
      height: 100%;
    }
  }

  .blog-card__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-slow) var(--ease-out);
  }

  .blog-card:hover .blog-card__img {
    transform: scale(1.05);
  }

  .blog-card__placeholder {
    width: 100%;
    height: 100%;
    min-height: 8rem;
    background: var(--gradient-hero);
  }

  .blog-card__body {
    padding: 1rem 1.25rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .blog-card__tag {
    display: inline-flex;
    align-items: center;
    width: fit-content;
    border-radius: var(--radius-full);
    background: var(--tag-bg, var(--color-primary-muted));
    color: var(--tag-color, var(--color-primary));
    padding: 0.125rem 0.5rem;
    font-size: 0.6875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .blog-card__title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    line-height: 1.4;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    transition: color var(--duration-fast) var(--ease-out);
  }

  .blog-card:hover .blog-card__title {
    color: var(--color-primary);
  }

  .blog-card__meta {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: var(--color-text-subtle);
    margin-top: 0.375rem;
  }

  .blog-card__excerpt {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-top: 0.5rem;
    margin-bottom: 0;
  }

  /* Pagination */
  .blog-pagination {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .blog-pagination__count {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  .blog-pagination__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 1.5rem;
    border-radius: var(--radius-full);
    border: 1px solid var(--color-border);
    background: var(--color-surface);
    color: var(--color-text);
    font-family: var(--font-heading);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background var(--duration-fast) var(--ease-out),
                border-color var(--duration-fast) var(--ease-out),
                color var(--duration-fast) var(--ease-out);
  }

  .blog-pagination__btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .blog-pagination__btn[hidden] {
    display: none;
  }
</style>

<script>
  function initBlogPagination() {
    const PAGE_SIZE = 12
    const list = document.querySelector<HTMLElement>('.blog-list')
    const btn = document.querySelector<HTMLButtonElement>('[data-load-more]')
    const showingEl = document.querySelector<HTMLElement>('[data-showing]')
    const totalCountEl = document.querySelector<HTMLElement>('[data-total-count]')

    if (!list) return

    const allCards = Array.from(list.querySelectorAll<HTMLElement>('.blog-card'))
    const total = allCards.length
    let visible = Math.min(PAGE_SIZE, total)

    function updateDisplay() {
      for (let i = 0; i < allCards.length; i++) {
        allCards[i].style.display = i < visible ? '' : 'none'
      }

      if (showingEl) showingEl.textContent = String(visible)
      if (totalCountEl) totalCountEl.textContent = String(total)
      if (btn) {
        btn.hidden = visible >= total
      }
    }

    if (btn) {
      btn.addEventListener('click', () => {
        visible = Math.min(visible + PAGE_SIZE, total)
        updateDisplay()
      })
    }

    updateDisplay()
  }

  document.addEventListener('astro:page-load', initBlogPagination)
  initBlogPagination()
</script>
