---
import { getCollection } from 'astro:content'
import Layout from '../layouts/IndexLayout.astro'
import SocialLinks from '../components/partials/IndexSocialLinks.astro'
import FormattedDate from '../components/partials/FormattedDate.astro'
import Badge from '../components/partials/Badge.astro'
import { professionalBadges, formerRoles, currentRole } from '../config/personal'
import { getOGImagePath } from '../lib/og-image'

const posts = (await getCollection('blog')).sort(
  (b, a) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf(),
)
const speakingEntries = (await getCollection('speaking')).sort(
  (b, a) => a.data.date.valueOf() - b.data.date.valueOf(),
)
const notes = (await getCollection('note')).sort(
  (b, a) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf(),
)
const projects = (await getCollection('project')).sort(
  (b, a) => a.data.date.valueOf() - b.data.date.valueOf(),
)

interface ActivityItem {
  type: 'article' | 'talk' | 'note' | 'project'
  title: string
  description?: string
  date: Date
  url: string
  heroImage?: string
  slug?: string
}

const allActivity: ActivityItem[] = [
  ...posts.map((p) => ({
    type: 'article' as const,
    title: p.data.title,
    description: p.data.description,
    date: new Date(p.data.pubDateTime),
    url: `/blog/${p.slug}/`,
    heroImage: p.data.heroImage && p.data.heroImage !== '/placeholder-hero.png' ? p.data.heroImage : undefined,
    slug: p.slug,
  })),
  ...speakingEntries.slice(0, 10).map((s) => ({
    type: 'talk' as const,
    title: s.data.title,
    description: s.data.event,
    date: new Date(s.data.date),
    url: s.data.url,
  })),
  // Group notes by day and emit one activity item per day
  ...(() => {
    const notesByDay = new Map<string, typeof notes>()
    for (const n of notes) {
      const key = new Date(n.data.pubDateTime).toISOString().slice(0, 10)
      if (!notesByDay.has(key)) notesByDay.set(key, [])
      notesByDay.get(key)!.push(n)
    }
    return [...notesByDay.entries()].map(([, dayNotes]) => {
      const daySummary = dayNotes.find((n) => n.data.daySummary)?.data.daySummary
      if (dayNotes.length === 1) {
        const n = dayNotes[0]
        return {
          type: 'note' as const,
          title: n.data.title ?? 'Note',
          description: n.data.description,
          date: new Date(n.data.pubDateTime),
          url: `/notes/${n.slug}/`,
        }
      }
      return {
        type: 'note' as const,
        title: `${dayNotes.length} Notes`,
        description: daySummary ?? dayNotes.map((n) => n.data.title ?? n.data.description).filter(Boolean).join(', '),
        date: new Date(dayNotes[0].data.pubDateTime),
        url: '/notes/',
      }
    })
  })(),
  ...projects.map((p) => ({
    type: 'project' as const,
    title: p.data.title,
    description: p.data.description,
    date: new Date(p.data.date),
    url: p.data.repoUrl,
  })),
]
  .sort((a, b) => b.date.valueOf() - a.date.valueOf())
  .slice(0, 8)

const badgeClasses: Record<ActivityItem['type'], string> = {
  article: 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300',
  talk: 'bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-300',
  note: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300',
  project: 'bg-violet-100 text-violet-700 dark:bg-violet-900/40 dark:text-violet-300',
}

const badgeLabels: Record<ActivityItem['type'], string> = {
  article: 'Article',
  talk: 'Talk',
  note: 'Note',
  project: 'Project',
}
---

<Layout
  title="Chris Lloyd-Jones | Sealjay"
  description="Software engineer, open source & sustainability advocate based in London"
  pubDateTime={new Date('1 March 2023')}
  updatedDate={new Date('1 March 2023')}
  heroImage="/chris/portrait.jpg"
>
  <!-- Hero Section -->
  <div class="w-full max-w-5xl mx-auto pt-6 md:pt-12">
    <div class="flex flex-col md:flex-row md:items-center md:gap-12">
      <!-- Image on mobile (top) and desktop (right) -->
      <div class="md:hidden mb-8 mx-auto">
        <div class="relative w-32 h-32 overflow-hidden rounded-full ring-4 ring-accent-100 dark:ring-accent-900">
          <img
            src="/chris/portrait.jpg"
            alt="Chris Lloyd-Jones"
            class="w-full h-full object-cover"
          />
        </div>
      </div>

      <!-- Text Content -->
      <div class="flex-1">
        <div class="inline-flex items-center rounded-full bg-accent-100/80 dark:bg-accent-900/30 px-3 py-1 text-sm text-accent-700 dark:text-accent-300 mb-4">
          <span class="font-medium">{currentRole.displayText}</span>
        </div>

        <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 md:text-5xl">
          Software engineer, open source & sustainability enthusiast.
        </h1>

        <p class="mt-6 text-base sm:text-lg text-zinc-600 dark:text-zinc-400 max-w-2xl">
          I&apos;m Chris - or Sealjay; I&apos;m a software engineer, and &lsquo;open&rsquo; enthusiast, living in London. I&apos;m deeply embedded in the Open Source community, and a passionate advocate for the thoughtful &amp; sustainable use of AI.
        </p>

        <div class="mt-4 flex flex-wrap gap-2 text-sm text-accent-600 dark:text-accent-400 font-medium">
          {professionalBadges.map(badge => (
            <Badge
              text={badge.text}
              url={badge.url}
              isFormerRole={badge.isFormerRole}
            />
          ))}
        </div>

        <div class="mt-8">
          <SocialLinks />
        </div>
      </div>

      <!-- Image on desktop (right side) -->
      <div class="hidden md:block flex-shrink-0">
        <div class="relative w-56 h-56 overflow-hidden rounded-2xl shadow-xl ring-1 ring-zinc-100 dark:ring-zinc-700/30">
          <img
            src="/chris/portrait.jpg"
            alt="Chris Lloyd-Jones"
            class="w-full h-full object-cover transition-transform duration-500 hover:scale-105"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- Section Divider -->
  <div class="w-full max-w-5xl mx-auto my-12 md:my-16">
    <div class="h-px bg-gradient-to-r from-transparent via-accent-300/70 dark:via-accent-700/30 to-transparent"></div>
  </div>

  <!-- Recent Activity Section -->
  <div class="w-full max-w-5xl mx-auto">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl sm:text-2xl font-bold text-zinc-800 dark:text-zinc-100">Recent Activity</h2>
      <a href="/stream" class="text-accent-600 dark:text-accent-400 hover:text-accent-700 dark:hover:text-accent-300 font-medium text-sm flex items-center gap-1 transition-colors">
        View all
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>

    <div class="flex flex-col gap-3">
      {
        allActivity.map((item) => {
          const isExternal = item.type === 'talk' || item.type === 'project'
          return (
            <a
              href={item.url}
              target={isExternal ? '_blank' : undefined}
              rel={isExternal ? 'noopener noreferrer' : undefined}
              class="group flex items-center gap-4 rounded-xl bg-white/90 dark:bg-zinc-800/70 backdrop-blur border border-zinc-100 dark:border-zinc-700/40 px-4 py-3 shadow-sm hover:shadow-md transition-all duration-200 hover:-translate-y-0.5"
            >
              {/* Type Badge */}
              <span class={`shrink-0 inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${badgeClasses[item.type]}`}>
                {badgeLabels[item.type]}
              </span>

              {/* Date */}
              <span class="shrink-0 text-xs text-zinc-500 dark:text-zinc-400 w-20 hidden sm:block">
                <FormattedDate date={item.date} />
              </span>

              {/* Title & Description */}
              <div class="min-w-0 flex-1">
                <span class="text-sm font-semibold text-zinc-900 dark:text-zinc-100 group-hover:text-accent-600 dark:group-hover:text-accent-400 transition-colors">
                  {item.title}
                </span>
                {item.description && (
                  <span class="ml-2 text-sm text-zinc-500 dark:text-zinc-400 line-clamp-1 hidden md:inline">
                    &mdash; {item.description}
                  </span>
                )}
              </div>

              {/* Arrow */}
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="shrink-0 h-4 w-4 text-zinc-400 dark:text-zinc-500 transition-transform duration-200 group-hover:translate-x-0.5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </a>
          )
        })
      }
    </div>
  </div>
</Layout>
