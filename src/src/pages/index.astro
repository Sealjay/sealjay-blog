---
import { getCollection } from 'astro:content'
import Layout from '../layouts/BaseLayout.astro'
import SocialLinks from '../components/partials/IndexSocialLinks.astro'
import Badge from '../components/partials/Badge.astro'
import LatestArticle from '../components/home/LatestArticle.astro'
import RecentTalks from '../components/home/RecentTalks.astro'
import FeaturedProjects from '../components/home/FeaturedProjects.astro'
import LatestNotes from '../components/home/LatestNotes.astro'
import { professionalBadges, currentRole } from '../config/personal'

// --- Data fetching ---
const posts = (await getCollection('blog')).sort(
  (b, a) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf(),
)
const speakingEntries = (await getCollection('speaking')).sort(
  (b, a) => a.data.date.valueOf() - b.data.date.valueOf(),
)
const notes = (await getCollection('note')).sort(
  (b, a) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf(),
)
const projectEntries = (await getCollection('project')).sort(
  (b, a) => a.data.date.valueOf() - b.data.date.valueOf(),
)

// --- Curated section data ---
const latestPost = posts[0]
const recentTalks = speakingEntries.slice(0, 3)
const featuredProjects = (() => {
  const featured = projectEntries.filter((p) => p.data.featured)
  if (featured.length >= 3) return featured.slice(0, 3)
  const remaining = projectEntries.filter((p) => !p.data.featured)
  return [...featured, ...remaining].slice(0, 3)
})()

// --- Notes day-group data ---
const notesByDay = new Map<string, typeof notes>()
for (const n of notes) {
  const key = new Date(n.data.pubDateTime).toISOString().slice(0, 10)
  if (!notesByDay.has(key)) notesByDay.set(key, [])
  notesByDay.get(key)!.push(n)
}

const sortedDayKeys = [...notesByDay.keys()].sort((a, b) => b.localeCompare(a))
const latestDayKey = sortedDayKeys[0]
const latestDayNotes = latestDayKey ? notesByDay.get(latestDayKey)! : []
const sortedLatestDay = [...latestDayNotes].sort(
  (a, b) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf(),
)
const latestDaySummary = sortedLatestDay.find((n) => n.data.daySummary)?.data.daySummary
const latestDayUrl = latestDayKey ? `/notes/${latestDayKey}/` : '/notes'
const latestDayPreviews = sortedLatestDay.slice(0, 3).map((n) => ({
  description: n.data.description,
  title: n.data.title,
  time: new Date(n.data.pubDateTime).toLocaleTimeString('en-GB', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }),
  url: `/notes/${latestDayKey}/#${n.slug}`,
}))

---

<Layout
  title="Chris Lloyd-Jones | Sealjay"
  description="Software engineer, open source & sustainability advocate based in London"
  pubDateTime={new Date('1 March 2023')}
  updatedDate={new Date('1 March 2023')}
  heroImage="/chris/portrait.jpg"
>
  <!-- Hero Section -->
  <div class="h-card w-full max-w-5xl mx-auto pt-6 md:pt-12">
    <a href="https://sealjay.com" class="u-url u-uid hidden" aria-hidden="true">Chris Lloyd-Jones</a>
    <a href="https://orcid.org/0000-0001-7995-7865" class="u-url hidden" rel="me" aria-hidden="true">ORCID</a>
    <div class="flex flex-col md:flex-row md:items-center md:gap-12">
      <!-- Image on mobile (top) and desktop (right) -->
      <div class="md:hidden mb-8 mx-auto">
        <div class="relative w-32 [height:8rem] overflow-hidden rounded-full ring-4 ring-accent-100 dark:ring-accent-900">
          <img
            src="/chris/portrait.jpg"
            alt="Chris Lloyd-Jones"
            class="u-photo w-full [height:100%] object-cover"
            loading="lazy"
          />
        </div>
      </div>

      <!-- Text Content -->
      <div class="flex-1">
        <div class="inline-flex items-center rounded-full bg-accent-100/80 dark:bg-accent-900/30 px-3 py-1 text-sm text-accent-700 dark:text-accent-300 mb-4">
          <span class="p-job-title font-medium">{currentRole.displayText}</span>
        </div>

        <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 md:text-5xl">
          <span class="p-name">Chris Lloyd-Jones</span> &mdash; Software engineer, open source & sustainability enthusiast.
        </h1>

        <p class="p-note mt-6 text-base sm:text-lg text-zinc-600 dark:text-zinc-400 max-w-2xl">
          I&apos;m Chris - or <span class="p-nickname">Sealjay</span>; I&apos;m a software engineer, and &lsquo;open&rsquo; enthusiast, living in London. I&apos;m deeply embedded in the Open Source community, and a passionate advocate for the thoughtful &amp; sustainable use of AI.
        </p>

        <div class="mt-4 flex flex-wrap gap-2 text-sm text-accent-600 dark:text-accent-400 font-medium">
          {professionalBadges.slice(0, 3).map(badge => (
            <Badge
              text={badge.text}
              url={badge.url}
              isFormerRole={badge.isFormerRole}
            />
          ))}
        </div>

        <div class="mt-8">
          <SocialLinks />
        </div>
      </div>

      <!-- Image on desktop (right side) -->
      <div class="hidden md:block flex-shrink-0">
        <div class="relative w-56 [height:14rem] overflow-hidden rounded-2xl shadow-xl ring-1 ring-zinc-100 dark:ring-zinc-700/30">
          <img
            src="/chris/portrait.jpg"
            alt="Chris Lloyd-Jones"
            class="u-photo w-full [height:100%] object-cover transition-transform duration-500 hover:scale-105"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- Section Divider -->
  <div class="section-divider max-w-5xl mx-auto"></div>

  <!-- Curated Sections Band -->
  <div class="w-full max-w-5xl mx-auto">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {latestPost && <LatestArticle post={latestPost} />}
      {recentTalks.length > 0 && <RecentTalks entries={recentTalks} />}
      {featuredProjects.length > 0 && <FeaturedProjects projects={featuredProjects} />}
    </div>
  </div>

  <!-- Section Divider -->
  <div class="section-divider max-w-5xl mx-auto"></div>

  <!-- Latest Notes Strip -->
  {latestDayKey && sortedLatestDay.length > 0 && (
    <div class="w-full max-w-5xl mx-auto mb-10 md:mb-12">
      <LatestNotes
        date={sortedLatestDay[0].data.pubDateTime}
        dayUrl={latestDayUrl}
        daySummary={latestDaySummary}
        noteCount={sortedLatestDay.length}
        previews={latestDayPreviews}
      />
    </div>
  )}

</Layout>

