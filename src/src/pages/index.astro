---
import { getCollection } from 'astro:content'
import Layout from '../layouts/BaseLayout.astro'

import SocialLinks from '../components/partials/IndexSocialLinks.astro'
import Badge from '../components/partials/Badge.astro'
import Button from '../components/partials/Button.astro'
import LatestArticle from '../components/home/LatestArticle.astro'
import RecentTalks from '../components/home/RecentTalks.astro'
import FeaturedProjects from '../components/home/FeaturedProjects.astro'
import LatestNotes from '../components/home/LatestNotes.astro'
import Container from '../components/containers/Container.astro'
import Section from '../components/containers/Section.astro'
import FormattedDate from '../components/partials/FormattedDate.astro'
import { currentRole } from '../config/personal'
import avatar from '../assets/chris/avatar.jpg'

// --- Data fetching ---
const posts = (await getCollection('blog')).sort(
  (b, a) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf(),
)
const speakingEntries = (await getCollection('speaking')).sort(
  (b, a) => a.data.date.valueOf() - b.data.date.valueOf(),
)
const notes = (await getCollection('note')).sort(
  (b, a) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf(),
)
const projectEntries = (await getCollection('project')).sort(
  (b, a) => a.data.date.valueOf() - b.data.date.valueOf(),
)

// --- Curated section data ---
const latestPost = posts[0]
const recentPosts = posts.slice(0, 3)
const nextTalk = speakingEntries.slice(0, 1)
const featuredProjects = (() => {
  const featured = projectEntries.filter((p) => p.data.featured)
  if (featured.length >= 3) return featured.slice(0, 3)
  const remaining = projectEntries.filter((p) => !p.data.featured)
  return [...featured, ...remaining].slice(0, 3)
})()

// --- Notes day-group data ---
const notesByDay = new Map<string, typeof notes>()
for (const n of notes) {
  const key = new Date(n.data.pubDateTime).toISOString().slice(0, 10)
  if (!notesByDay.has(key)) notesByDay.set(key, [])
  notesByDay.get(key)!.push(n)
}

const sortedDayKeys = [...notesByDay.keys()].sort((a, b) => b.localeCompare(a))
const latestDayKey = sortedDayKeys[0]
const latestDayNotes = latestDayKey ? notesByDay.get(latestDayKey)! : []
const sortedLatestDay = [...latestDayNotes].sort(
  (a, b) => a.data.pubDateTime.valueOf() - b.data.pubDateTime.valueOf(),
)
const latestDaySummary = sortedLatestDay.find((n) => n.data.daySummary)?.data.daySummary
const latestDayUrl = latestDayKey ? `/notes/${latestDayKey}/` : '/notes'
const latestDayPreviews = sortedLatestDay.slice(0, 3).map((n) => ({
  description: n.data.description,
  title: n.data.title,
  time: new Date(n.data.pubDateTime).toLocaleTimeString('en-GB', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }),
  url: `/notes/${latestDayKey}/#${n.slug}`,
}))

// --- Expertise tags for hero ---
const expertiseTags = ['AI Transformation', 'Green Software', 'Open Source', 'AI MVP']

---

<Layout
  title="Chris Lloyd-Jones, Sealjay"
  description="AI transformation, green software, and open source — Chris Lloyd-Jones (Sealjay), VP at Kyndryl and 6x Microsoft AI MVP"
  pubDateTime={new Date('1 March 2023')}
  updatedDate={new Date('1 March 2026')}
  heroImage={avatar.src}
>
  <!-- Hero Section -->
  <div class="hero-section">
    <!-- Ambient radial glow -->
    <div class="hero-glow" aria-hidden="true" />
    <Container class="hero-content">
      <div class="h-card">
        <a href="https://sealjay.com" class="u-url u-uid hidden" aria-hidden="true">Chris Lloyd-Jones</a>
        <a href="https://orcid.org/0000-0001-7995-7865" class="u-url hidden" rel="me" aria-hidden="true">ORCID</a>

        <!-- Name -->
        <h1 class="hero-title font-heading hero-anim" style="animation-delay: 0.08s;">
          <span class="p-name">Chris Lloyd-Jones</span>
        </h1>

        <!-- Subtitle -->
        <p class="hero-subtitle font-body hero-anim" style="animation-delay: 0.16s;">
          <span class="p-job-title">{currentRole.title}</span> &mdash; {currentRole.company}
        </p>

        <!-- Bio -->
        <p class="hero-bio font-body p-note hero-anim" style="animation-delay: 0.24s;">
          I'm Chris &mdash; or <span class="p-nickname">Sealjay</span>. I bridge AI transformation with enterprise governance, sustainability, and open source &mdash; from green software to agentic AI. 6x Microsoft MVP, doctoral researcher in Green Software Engineering, and co-host of <a href="https://securing.quest" class="hero-bio-link">Securing the Realm</a>.
        </p>

        <!-- Expertise tags -->
        <div class="hero-tags hero-anim" style="animation-delay: 0.28s;">
          {expertiseTags.map((tag) => (
            <Badge label={tag} variant="default" />
          ))}
        </div>

        <!-- Bento grid: Latest Article + Next Speaking -->
        <div class="hero-bento hero-anim" style="animation-delay: 0.36s;">
          {latestPost && <LatestArticle post={latestPost} />}
          {nextTalk.length > 0 && <RecentTalks entries={nextTalk} />}
        </div>

        <!-- Code signature -->
        <div class="hero-code-signature hero-anim" style="animation-delay: 0.44s;">
          <code><span class="code-comment">// </span><span class="code-keyword">open</span>, sustainable, real</code>
        </div>
      </div>
    </Container>
  </div>

  <!-- Recent Writing Section -->
  <Section bg="alt" ariaLabel="Recent writing">
    <Container>
      <h2 class="section-title font-heading">Recent Writing</h2>
      <div class="writing-list">
        {recentPosts.map((post) => {
          const firstTag = post.data.tags?.[0]
          const words = post.body?.split(/\s+/).length ?? 0
          const readingTime = Math.max(1, Math.ceil(words / 200))
          return (
            <a href={`/blog/${post.slug}/`} class="writing-card">
              <div class="writing-card__row">
                {firstTag && (
                  <span class="writing-card__tag">{firstTag}</span>
                )}
                <FormattedDate date={post.data.pubDateTime} class="writing-card__date" />
                <span class="writing-card__reading-time">{readingTime} min read</span>
              </div>
              <h3 class="writing-card__title font-heading">{post.data.title}</h3>
            </a>
          )
        })}
      </div>
      <div class="section-cta">
        <Button variant="ghost" href="/blog" size="sm">View all writing &rarr;</Button>
      </div>
    </Container>
  </Section>

  <!-- Featured Projects Section -->
  <Section bg="default" ariaLabel="Featured projects">
    <Container>
      <h2 class="section-title font-heading">Featured Projects</h2>
      {featuredProjects.length > 0 && <FeaturedProjects projects={featuredProjects} />}
    </Container>
  </Section>

  <!-- Latest Notes Section -->
  <Section bg="alt" ariaLabel="Latest notes">
    <Container>
      <h2 class="section-title font-heading">Latest Notes</h2>
      {latestDayKey && sortedLatestDay.length > 0 && (
        <LatestNotes
          date={sortedLatestDay[0].data.pubDateTime}
          dayUrl={latestDayUrl}
          daySummary={latestDaySummary}
          noteCount={sortedLatestDay.length}
          previews={latestDayPreviews}
        />
      )}
    </Container>
  </Section>

  <!-- Social Links -->
  <Section bg="default" ariaLabel="Social links">
    <Container>
      <SocialLinks />
    </Container>
  </Section>
</Layout>

<style>
  /* ============================================================
     Hero Section
     ============================================================ */
  .hero-section {
    position: relative;
    background: var(--gradient-hero);
    padding-top: 2rem;
    padding-bottom: 2rem;
    overflow: hidden;
  }

  @media (min-width: 768px) {
    .hero-section {
      padding-top: 3.5rem;
      padding-bottom: 2.5rem;
    }
  }

  .hero-glow {
    position: absolute;
    width: 500px;
    height: 500px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(79, 70, 229, 0.08) 0%, transparent 70%);
    top: -150px;
    right: -80px;
    pointer-events: none;
  }

  @media (max-width: 640px) {
    .hero-glow {
      width: 300px;
      height: 300px;
      top: -100px;
      right: -100px;
    }
  }

  .hero-content {
    position: relative;
    z-index: 1;
  }

  .hero-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-bottom: 1.5rem;
  }

  .hero-title {
    font-size: 2rem;
    line-height: 1.15;
    letter-spacing: -0.025em;
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 0.5rem;
  }

  @media (min-width: 768px) {
    .hero-title {
      font-size: 2.75rem;
    }
  }

  .hero-subtitle {
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-primary);
    margin: 0 0 1rem;
  }

  @media (min-width: 768px) {
    .hero-subtitle {
      font-size: 1.125rem;
    }
  }

  .hero-bio {
    color: var(--color-text-muted);
    font-size: 0.9375rem;
    line-height: 1.75;
    max-width: 520px;
    margin: 0 0 2rem;
  }

  .hero-bio :global(.hero-bio-link) {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
    transition: color var(--duration-fast) var(--ease-out);
  }

  .hero-bio :global(.hero-bio-link:hover) {
    color: var(--color-text);
    text-decoration: underline;
  }

  @media (min-width: 768px) {
    .hero-bio {
      font-size: 1rem;
    }
  }

  /* Bento grid */
  .hero-bento {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .hero-bento {
      grid-template-columns: 1fr 1fr;
    }
  }

  /* ============================================================
     Hero Code Signature
     ============================================================ */
  .hero-code-signature {
    margin-top: 1.5rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: 12px 20px;
    font-family: var(--font-code);
    font-size: 0.875rem;
    color: var(--color-text-muted);
    max-width: 100%;
  }

  .hero-code-signature code {
    font-family: inherit;
    font-size: inherit;
  }

  .code-comment {
    color: var(--color-text-subtle);
  }

  .code-keyword {
    color: var(--color-warm);
    font-weight: 600;
  }

  /* ============================================================
     Hero Staggered Fade-in-up Animations
     ============================================================ */
  @media (prefers-reduced-motion: no-preference) {
    .hero-anim {
      opacity: 0;
      animation: hero-fade-in-up 0.6s var(--ease-out) forwards;
    }

    @keyframes hero-fade-in-up {
      from {
        opacity: 0;
        transform: translateY(16px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .hero-anim {
      opacity: 1;
    }
  }

  /* ============================================================
     Section Titles
     ============================================================ */
  .section-title {
    font-size: 1.375rem;
    line-height: 1.25;
    letter-spacing: -0.02em;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 1.5rem;
  }

  @media (min-width: 768px) {
    .section-title {
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
    }
  }

  /* ============================================================
     Recent Writing — Compact Text-Only Cards
     ============================================================ */
  .writing-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .writing-card {
    display: block;
    padding: 1rem 1.5rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--color-card-glow);
    text-decoration: none;
    cursor: pointer;
    transition: transform 0.2s var(--ease-out),
                border-color 0.2s var(--ease-out),
                box-shadow 0.2s var(--ease-out);
  }

  .writing-card:hover {
    transform: translateY(-2px);
    border-color: var(--color-border-strong);
  }

  .writing-card:focus-visible {
    transform: translateY(-2px);
    border-color: var(--color-border-strong);
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .writing-card__row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 5px;
  }

  .writing-card__tag {
    display: inline-flex;
    align-items: center;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 12px;
    background: var(--color-primary-muted);
    color: var(--color-primary);
    font-weight: 500;
  }

  /* Override FormattedDate scoped styles when used as compact date */
  .writing-card :global(.formatted-date.writing-card__date) {
    font-size: 11px;
    color: var(--color-text-subtle);
    line-height: 1;
  }

  .writing-card__reading-time {
    font-size: 11px;
    color: var(--color-text-subtle);
    line-height: 1;
  }

  .writing-card__title {
    font-size: 15px;
    font-weight: 600;
    color: var(--color-text);
    line-height: 1.35;
    margin: 0;
    transition: color 0.2s var(--ease-out);
  }

  .writing-card:hover .writing-card__title {
    color: var(--color-primary);
  }

  /* ============================================================
     Section CTA
     ============================================================ */
  .section-cta {
    margin-top: 1.5rem;
    text-align: center;
  }

</style>
