---
interface Heading {
  depth: number
  slug: string
  text: string
}

interface Props {
  headings: Heading[]
  variant?: 'mobile' | 'desktop' | 'both'
}

const { headings, variant = 'both' } = Astro.props
const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3)
if (tocHeadings.length === 0) return
---

{(variant === 'mobile' || variant === 'both') && (
  <details class="toc-mobile">
    <summary class="toc-summary">
      <span class="toc-summary-text">Table of contents</span>
      <svg xmlns="http://www.w3.org/2000/svg" class="toc-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </summary>
    <nav aria-label="Table of contents">
      <ol class="toc-list">
        {tocHeadings.map((h) => (
          <li class:list={['toc-item', { 'toc-item--nested': h.depth === 3 }]}>
            <a href={`#${h.slug}`} class="toc-link">{h.text}</a>
          </li>
        ))}
      </ol>
    </nav>
  </details>
)}

{(variant === 'desktop' || variant === 'both') && (
  <aside class="toc-desktop" aria-label="Table of contents">
    <div class="toc-sticky">
      <span class="toc-heading">On this page</span>
      <nav>
        <ol class="toc-list">
          {tocHeadings.map((h) => (
            <li class:list={['toc-item', { 'toc-item--nested': h.depth === 3 }]}>
              <a href={`#${h.slug}`} class="toc-link" data-toc-link>{h.text}</a>
            </li>
          ))}
        </ol>
      </nav>
    </div>
  </aside>
)}

<style>
  /* Mobile ToC */
  .toc-mobile {
    display: block;
    margin-bottom: 1.5rem;
    border-radius: var(--radius-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
  }

  @media (min-width: 1024px) {
    .toc-mobile {
      display: none;
    }
  }

  .toc-summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    cursor: pointer;
    list-style: none;
    user-select: none;
  }

  .toc-summary::-webkit-details-marker {
    display: none;
  }

  .toc-summary-text {
    font-family: var(--font-heading);
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .toc-chevron {
    width: 1rem;
    height: 1rem;
    color: var(--color-text-subtle);
    transition: transform var(--duration-fast) var(--ease-out);
  }

  details[open] .toc-chevron {
    transform: rotate(180deg);
  }

  .toc-mobile .toc-list {
    padding: 0 1rem 0.75rem;
  }

  /* Desktop ToC */
  .toc-desktop {
    display: none;
  }

  @media (min-width: 1024px) {
    .toc-desktop {
      display: block;
    }
  }

  .toc-sticky {
    position: sticky;
    top: 5rem;
    max-height: calc(100vh - 6rem);
    overflow-y: auto;
    padding: 1rem;
    border-radius: var(--radius-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
  }

  .toc-heading {
    display: block;
    font-family: var(--font-heading);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-subtle);
    margin-bottom: 0.75rem;
  }

  /* Shared list styles */
  .toc-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .toc-item {
    margin: 0;
  }

  .toc-item--nested {
    padding-left: 0.75rem;
  }

  .toc-link {
    display: block;
    padding: 0.25rem 0.5rem;
    border-left: 2px solid transparent;
    font-family: var(--font-heading);
    font-size: 0.8125rem;
    font-weight: 400;
    line-height: 1.4;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--duration-fast) var(--ease-out),
                border-color var(--duration-fast) var(--ease-out);
  }

  .toc-link:hover {
    color: var(--color-primary);
  }

  .toc-link.active {
    color: var(--color-primary);
    border-left-color: var(--color-primary);
    font-weight: 500;
  }

  .toc-link:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
    border-radius: 2px;
  }
</style>

<script>
  function initTableOfContents() {
    const tocLinks = document.querySelectorAll<HTMLAnchorElement>('[data-toc-link]')
    if (tocLinks.length === 0) return

    const headingIds = Array.from(tocLinks).map((link) => {
      const href = link.getAttribute('href')
      return href ? href.slice(1) : ''
    }).filter(Boolean)

    const headingElements = headingIds
      .map((id) => document.getElementById(id))
      .filter((el): el is HTMLElement => el !== null)

    if (headingElements.length === 0) return

    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting) {
            const id = entry.target.id
            for (const link of tocLinks) {
              const href = link.getAttribute('href')
              link.classList.toggle('active', href === `#${id}`)
            }
          }
        }
      },
      { rootMargin: '-80px 0px -70% 0px', threshold: 0 }
    )

    for (const heading of headingElements) {
      observer.observe(heading)
    }
  }

  initTableOfContents()
  document.addEventListener('astro:page-load', initTableOfContents)
</script>
