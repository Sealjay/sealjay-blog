---
---

<site-search>
  <button
    type="button"
    class="search-trigger"
    aria-label="Search site"
    id="search-open-button"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
    <kbd class="search-shortcut" aria-hidden="true">âŒ˜K</kbd>
  </button>

  <dialog
    id="search-dialog"
    class="search-overlay"
    aria-modal="true"
    aria-label="Search"
  >
    <div class="search-panel">
      <div class="search-input-wrap">
        <svg xmlns="http://www.w3.org/2000/svg" class="search-input-icon" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="search"
          id="search-input"
          class="search-input"
          placeholder="Search posts, notes, projects..."
          autocomplete="off"
          aria-label="Search query"
          aria-controls="search-results"
          aria-autocomplete="list"
          role="combobox"
          aria-expanded="false"
          aria-haspopup="listbox"
        />
        <kbd class="search-kbd">Esc</kbd>
      </div>

      <div class="search-divider"></div>
      <div id="search-status" role="status" aria-live="polite" class="search-status-wrap">
        <p id="search-empty" class="search-status hidden">
          No results found.
        </p>
        <p id="search-initial" class="search-status">
          Start typing to search...
        </p>
      </div>
      <ul
        id="search-results"
        role="listbox"
        aria-label="Search results"
        class="search-results"
      >
      </ul>
    </div>
  </dialog>
</site-search>

<style>
  /* Trigger button */
  .search-trigger {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    padding: 0;
    border: none;
    border-radius: var(--radius-sm);
    background: transparent;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: background-color var(--duration-fast) var(--ease-out),
                color var(--duration-fast) var(--ease-out);
  }

  .search-trigger:hover {
    background: var(--color-primary-muted);
    color: var(--color-primary);
  }

  .search-trigger:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .search-shortcut {
    display: none;
    font-family: var(--font-code);
    font-size: 11px;
    color: var(--color-text-subtle);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 2px 6px;
    line-height: 1.2;
    pointer-events: none;
  }

  @media (min-width: 768px) {
    .search-trigger {
      gap: 6px;
      width: auto;
      padding: 0 12px;
    }

    .search-shortcut {
      display: inline-flex;
    }
  }

  /* Overlay */
  .search-overlay {
    position: fixed;
    inset: 0;
    z-index: 200;
    margin: 0;
    padding: 0;
    width: 100%;
    max-width: 100%;
    height: 100%;
    max-height: 100%;
    border: none;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    overscroll-behavior: contain;
  }

  .search-overlay[open] {
    display: flex;
    align-items: flex-start;
    justify-content: center;
  }

  .search-overlay::backdrop {
    display: none;
  }

  /* Dialog panel */
  .search-panel {
    margin-top: 5vh;
    width: calc(100% - 32px);
    max-width: 560px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: 0 4px 40px rgba(0, 0, 0, 0.15);
  }

  @media (min-width: 640px) {
    .search-panel {
      margin-top: 10vh;
    }
  }

  /* Search input area */
  .search-input-wrap {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-input-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-subtle);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    height: 48px;
    padding: 0 48px 0 48px;
    border: none;
    background: var(--color-bg);
    border-radius: var(--radius-md);
    margin: 8px;
    font-family: var(--font-body);
    font-size: 1rem;
    color: var(--color-text);
    transition: outline-color var(--duration-fast) var(--ease-out);
  }

  .search-input::placeholder {
    color: var(--color-text-subtle);
  }

  .search-input:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  /* Escape key badge */
  .search-kbd {
    display: none;
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    align-items: center;
    padding: 2px 8px;
    border: 1px solid var(--color-border-strong);
    border-radius: 6px;
    font-family: var(--font-code);
    font-size: 0.6875rem;
    color: var(--color-text-subtle);
    line-height: 1.4;
  }

  @media (min-width: 640px) {
    .search-kbd {
      display: inline-flex;
    }
  }

  /* Divider between input and results */
  .search-divider {
    height: 1px;
    background: var(--color-border);
  }

  /* Results list */
  .search-results {
    max-height: 50vh;
    overflow-y: auto;
    padding: 8px;
    margin: 0;
    list-style: none;
    scrollbar-width: thin;
    scrollbar-color: var(--color-border-strong) transparent;
  }

  /* Status messages (empty + initial) */
  .search-status {
    padding: 32px 16px;
    text-align: center;
    font-size: 0.875rem;
    color: var(--color-text-subtle);
    margin: 0;
  }

  .hidden {
    display: none;
  }
</style>

<script>
  import Fuse from 'fuse.js'

  interface SearchItem {
    title: string
    description: string
    tags: string[]
    url: string
    type: 'blog' | 'speaking' | 'note' | 'project' | 'short'
  }

  class SiteSearch extends HTMLElement {
    private fuse: Fuse<SearchItem> | null = null
    private dialog: HTMLDialogElement | null = null
    private input: HTMLInputElement | null = null
    private resultsList: HTMLElement | null = null
    private emptyState: HTMLElement | null = null
    private initialState: HTMLElement | null = null
    private activeIndex = -1
    private searchTrackTimeout: ReturnType<typeof setTimeout> | null = null
    private previouslyFocused: HTMLElement | null = null

    constructor() {
      super()

      this.dialog = this.querySelector('#search-dialog')
      this.input = this.querySelector('#search-input')
      this.resultsList = this.querySelector('#search-results')
      this.emptyState = this.querySelector('#search-empty')
      this.initialState = this.querySelector('#search-initial')

      const openButton = this.querySelector('#search-open-button')

      openButton?.addEventListener('click', () => this.openDialog())

      // Global keyboard shortcut: Ctrl/Cmd + K
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault()
          this.openDialog()
        }
      })

      // Custom event: allow other components (e.g. 404 page) to open search
      document.addEventListener('open-search', () => this.openDialog())

      this.dialog?.addEventListener('click', (e) => {
        if (e.target === this.dialog) this.closeDialog()
      })

      this.dialog?.addEventListener('close', () => {
        this.resetSearch()
      })

      this.input?.addEventListener('input', () => {
        this.search(this.input!.value)
      })

      this.input?.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          this.closeDialog()
        } else if (e.key === 'ArrowDown') {
          e.preventDefault()
          this.moveSelection(1)
        } else if (e.key === 'ArrowUp') {
          e.preventDefault()
          this.moveSelection(-1)
        } else if (e.key === 'Enter') {
          e.preventDefault()
          this.selectCurrent()
        }
      })

      // Focus trap within dialog
      this.dialog?.addEventListener('keydown', (e) => {
        if (e.key !== 'Tab') return
        const focusable = this.dialog!.querySelectorAll<HTMLElement>(
          'input, button, a[href], [tabindex]:not([tabindex="-1"])'
        )
        if (focusable.length === 0) return
        const first = focusable[0]
        const last = focusable[focusable.length - 1]
        if (e.shiftKey) {
          if (document.activeElement === first) {
            e.preventDefault()
            last.focus()
          }
        } else {
          if (document.activeElement === last) {
            e.preventDefault()
            first.focus()
          }
        }
      })
    }

    async loadIndex() {
      if (this.fuse) return
      const res = await fetch('/search.json')
      const data: SearchItem[] = await res.json()
      this.fuse = new Fuse(data, {
        keys: [
          { name: 'title', weight: 2 },
          { name: 'description', weight: 1 },
          { name: 'tags', weight: 0.5 },
        ],
        threshold: 0.3,
        includeMatches: true,
      })
    }

    openDialog() {
      this.previouslyFocused = document.activeElement as HTMLElement | null
      this.loadIndex()
      this.dialog?.showModal()
      this.input?.focus()
    }

    closeDialog() {
      this.dialog?.close()
      this.previouslyFocused?.focus()
      this.previouslyFocused = null
    }

    resetSearch() {
      if (this.input) this.input.value = ''
      this.activeIndex = -1
      this.clearResults()
      if (this.initialState) this.initialState.classList.remove('hidden')
      if (this.emptyState) this.emptyState.classList.add('hidden')
      this.input?.setAttribute('aria-expanded', 'false')
    }

    clearResults() {
      if (!this.resultsList) return
      const items = this.resultsList.querySelectorAll('[data-search-result]')
      for (const item of items) item.remove()
    }

    search(query: string) {
      if (!query.trim()) {
        this.resetSearch()
        return
      }

      if (!this.fuse) return

      const results = this.fuse.search(query, { limit: 10 })

      // Track search queries in Plausible (debounced to avoid firing on every keystroke)
      if (this.searchTrackTimeout) clearTimeout(this.searchTrackTimeout)
      this.searchTrackTimeout = setTimeout(() => {
        if (typeof window.plausible !== 'undefined') {
          window.plausible('Search', { props: { query, resultCount: String(results.length) } })
        }
      }, 1000)

      this.clearResults()
      this.activeIndex = -1
      if (this.initialState) this.initialState.classList.add('hidden')

      if (results.length === 0) {
        if (this.emptyState) this.emptyState.classList.remove('hidden')
        this.input?.setAttribute('aria-expanded', 'false')
        return
      }

      if (this.emptyState) this.emptyState.classList.add('hidden')
      this.input?.setAttribute('aria-expanded', 'true')

      for (const [i, result] of results.entries()) {
        const item = result.item
        const li = document.createElement('li')
        li.setAttribute('data-search-result', '')
        li.setAttribute('role', 'option')
        li.setAttribute('aria-selected', 'false')
        li.id = `search-result-${i}`

        const isExternal = item.type === 'speaking' || item.type === 'project' || item.type === 'short'
        const rel = isExternal ? ' rel="noopener noreferrer" target="_blank"' : ''
        const externalIcon = isExternal
          ? '<span class="sr-only">(opens in new tab)</span>'
          : ''

        // Type badge colour mapping using CSS variables
        const typeBadgeMap: Record<string, { cssVar: string; label: string }> = {
          blog: { cssVar: 'primary', label: 'Blog' },
          speaking: { cssVar: 'subtle', label: 'Talk' },
          note: { cssVar: 'warm', label: 'Note' },
          project: { cssVar: 'subtle', label: 'Project' },
          short: { cssVar: 'success', label: 'Short' },
        }
        const badgeInfo = typeBadgeMap[item.type] ?? typeBadgeMap.blog
        const typeLabel = `<span class="search-badge search-badge--${badgeInfo.cssVar}">${badgeInfo.label}</span>`

        li.innerHTML = `
          <a href="${item.url}"${rel} class="search-result-link">
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                ${typeLabel}
                ${externalIcon}
              </div>
              <div class="search-result-title">${this.escapeHtml(item.title)}</div>
              <div class="search-result-desc">${this.escapeHtml(item.description)}</div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; flex-shrink: 0; margin-top: 4px; color: var(--color-text-subtle);" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        `

        this.resultsList?.appendChild(li)
      }
    }

    moveSelection(direction: number) {
      const items = this.resultsList?.querySelectorAll('[data-search-result]')
      if (!items || items.length === 0) return

      // Deselect current
      if (this.activeIndex >= 0 && this.activeIndex < items.length) {
        items[this.activeIndex].setAttribute('aria-selected', 'false')
        const link = items[this.activeIndex].querySelector('a') as HTMLElement
        if (link) link.style.background = ''
      }

      this.activeIndex += direction
      if (this.activeIndex < 0) this.activeIndex = items.length - 1
      if (this.activeIndex >= items.length) this.activeIndex = 0

      const active = items[this.activeIndex]
      active.setAttribute('aria-selected', 'true')
      const activeLink = active.querySelector('a') as HTMLElement
      if (activeLink) activeLink.style.background = 'var(--color-primary-muted)'
      active.scrollIntoView({ block: 'nearest' })
      this.input?.setAttribute('aria-activedescendant', active.id)
    }

    selectCurrent() {
      const items = this.resultsList?.querySelectorAll('[data-search-result]')
      if (!items || this.activeIndex < 0 || this.activeIndex >= items.length) return
      const link = items[this.activeIndex].querySelector('a') as HTMLAnchorElement
      if (link) {
        this.closeDialog()
        link.click()
      }
    }

    escapeHtml(str: string) {
      const div = document.createElement('div')
      div.textContent = str
      return div.innerHTML
    }
  }

  customElements.define('site-search', SiteSearch)
</script>

<style is:global>
  /* Result link - needs global because it's injected via JS */
  .search-result-link {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    cursor: pointer;
    transition: background-color var(--duration-fast) var(--ease-out);
  }

  .search-result-link:hover {
    background: var(--color-surface-hover);
  }

  /* Result title */
  .search-result-title {
    font-family: var(--font-heading);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Result description */
  .search-result-desc {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-top: 2px;
  }

  /* Type badges */
  .search-badge {
    display: inline-flex;
    align-items: center;
    padding: 1px 8px;
    border-radius: var(--radius-full);
    font-size: 0.6875rem;
    font-weight: 500;
    line-height: 1.6;
  }

  .search-badge--primary {
    background: var(--color-primary-muted);
    color: var(--color-primary);
  }

  .search-badge--warm {
    background: var(--color-warm-muted);
    color: var(--color-warm);
  }

  .search-badge--success {
    background: rgba(5, 150, 105, 0.08);
    color: var(--color-success);
  }

  [data-theme="dark"] .search-badge--success {
    background: rgba(52, 211, 153, 0.15);
  }

  .search-badge--subtle {
    background: var(--color-surface-hover);
    color: var(--color-text-subtle);
  }
</style>
