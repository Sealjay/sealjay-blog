---
---

<mode-toggle>
  <button
    id="theme-toggle"
    role="switch"
    aria-checked="false"
    aria-label="Switch to dark mode"
    style="
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border: none;
      border-radius: var(--radius-sm, 8px);
      background: transparent;
      cursor: pointer;
      padding: 0;
      color: var(--color-text-muted);
      transition: background-color 0.2s ease, color 0.2s ease;
    "
  >
    <span id="icon-sun" style="
      position: absolute;
      transition: opacity 0.3s ease, transform 0.3s ease;
    ">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    </span>
    <span id="icon-moon" style="
      position: absolute;
      transition: opacity 0.3s ease, transform 0.3s ease;
    ">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </span>
  </button>
</mode-toggle>

<script>
  function updateHTMLTheme(mode: "light" | "dark") {
    document.documentElement.setAttribute("data-theme", mode);

    const themeColorMetaTag = document.head.querySelector(
      'meta[name="theme-color"]',
    );
    if (themeColorMetaTag) {
      (themeColorMetaTag as HTMLMetaElement).content =
        mode === "dark" ? "#0C0A1D" : "#F8F9FC";
    }

    sessionStorage.setItem("theme", mode);
  }

  function updateIcons(mode: "light" | "dark") {
    const sunIcon = document.getElementById("icon-sun");
    const moonIcon = document.getElementById("icon-moon");
    if (!sunIcon || !moonIcon) return;

    if (mode === "dark") {
      sunIcon.style.opacity = "0";
      sunIcon.style.transform = "rotate(-90deg) scale(0.5)";
      moonIcon.style.opacity = "1";
      moonIcon.style.transform = "rotate(0deg) scale(1)";
    } else {
      sunIcon.style.opacity = "1";
      sunIcon.style.transform = "rotate(0deg) scale(1)";
      moonIcon.style.opacity = "0";
      moonIcon.style.transform = "rotate(90deg) scale(0.5)";
    }
  }

  class ModeToggle extends HTMLElement {
    constructor() {
      super();

      // Resolve current mode from localStorage or system preference
      let currentMode: "light" | "dark";
      const stored = sessionStorage.getItem("theme");
      if (
        stored === "dark" ||
        (!stored &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        currentMode = "dark";
      } else {
        currentMode = "light";
      }

      updateHTMLTheme(currentMode);

      const toggle = this.querySelector<HTMLButtonElement>("#theme-toggle");
      if (!toggle) return;

      // Set initial icon visibility (no transition on first paint)
      const sunIcon = this.querySelector<HTMLElement>("#icon-sun");
      const moonIcon = this.querySelector<HTMLElement>("#icon-moon");
      if (sunIcon && moonIcon) {
        // Disable transitions for initial state to prevent flash
        sunIcon.style.transition = "none";
        moonIcon.style.transition = "none";
        updateIcons(currentMode);
        // Re-enable transitions after paint
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            sunIcon.style.transition =
              "opacity 0.3s ease, transform 0.3s ease";
            moonIcon.style.transition =
              "opacity 0.3s ease, transform 0.3s ease";
          });
        });
      }

      // Set initial ARIA state
      if (currentMode === "dark") {
        toggle.setAttribute("aria-checked", "true");
        toggle.setAttribute("aria-label", "Switch to light mode");
      } else {
        toggle.setAttribute("aria-checked", "false");
        toggle.setAttribute("aria-label", "Switch to dark mode");
      }

      // Hover styles
      toggle.addEventListener("mouseenter", () => {
        toggle.style.backgroundColor = "var(--color-primary-muted)";
        toggle.style.color = "var(--color-primary)";
      });
      toggle.addEventListener("mouseleave", () => {
        toggle.style.backgroundColor = "transparent";
        toggle.style.color = "var(--color-text-muted)";
      });

      // Click handler
      toggle.addEventListener("click", () => {
        currentMode = currentMode === "dark" ? "light" : "dark";
        updateHTMLTheme(currentMode);
        updateIcons(currentMode);

        toggle.setAttribute(
          "aria-checked",
          currentMode === "dark" ? "true" : "false",
        );
        toggle.setAttribute(
          "aria-label",
          currentMode === "dark"
            ? "Switch to light mode"
            : "Switch to dark mode",
        );

        if (typeof window.plausible !== "undefined") {
          window.plausible("Dark Mode Toggle", {
            props: { theme: currentMode },
          });
        }
      });
    }
  }

  customElements.define("mode-toggle", ModeToggle);
</script>
